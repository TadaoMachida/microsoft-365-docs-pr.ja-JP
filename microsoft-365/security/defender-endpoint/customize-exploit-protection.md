---
title: エクスプロイト保護をカスタマイズする
keywords: エクスプロイト保護、軽減策、有効化、PowerShell、dep、cfg、emet、aslr
description: Windows セキュリティ アプリまたは PowerShell を使用して、エクスプロイト保護で使用される特定の軽減策を有効または無効にすることができます。 軽減策を監査し、構成をエクスポートすることもできます。
ms.prod: m365-security
ms.mktglfcycl: manage
ms.sitesec: library
ms.localizationpriority: medium
audience: ITPro
ms.topic: conceptual
author: dansimp
ms.author: dansimp
ms.reviewer: ''
manager: dansimp
ms.technology: mde
ms.collection: m365-security-compliance
ms.date: ''
ms.openlocfilehash: b52238069a69a08921fec79c67ab979bd7668bb7
ms.sourcegitcommit: bdd6ffc6ebe4e6cb212ab22793d9513dae6d798c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/08/2022
ms.locfileid: "63322745"
---
# <a name="customize-exploit-protection"></a>エクスプロイト保護をカスタマイズする

[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]


**適用対象:**
- [Microsoft Defender for Endpoint Plan 1](https://go.microsoft.com/fwlink/p/?linkid=2154037)
- [Microsoft Defender for Endpoint Plan 2](https://go.microsoft.com/fwlink/p/?linkid=2154037)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

> Defender for Endpoint を試す場合は、 [無料試用版にサインアップしてください。](https://signup.microsoft.com/create-account/signup?products=7f379fee-c4f9-4278-b0a1-e4c8c2fcdf7e&ru=https://aka.ms/MDEp2OpenTrial?ocid=docs-wdatp-assignaccess-abovefoldlink)

エクスプロイト保護は、オペレーティング システム プロセスと個々のアプリの両方に、さまざまな悪用軽減手法を自動的に適用します。

個々のデバイスでWindows セキュリティ アプリを使用して、これらの設定を構成します。 次に、他のデバイスに展開できるように、構成を XML ファイルとしてエクスポートします。 グループ ポリシーを使用して、XML ファイルを一度に複数のデバイスに配布します。 PowerShell を使用して軽減策を構成することもできます。

この記事では、エクスプロイト保護で使用できる軽減策の一覧を示します。 軽減策をシステム全体または個々のアプリに適用できるかどうかを示し、軽減策のしくみの簡単な説明を提供します。

また、Windows セキュリティ、PowerShell、およびモバイル デバイス管理 (MDM) 構成サービス プロバイダー (CSP) を使用して軽減策を有効または構成する方法についても説明します。 これは、ネットワーク全体にデプロイできる構成を作成する最初の手順です。 次の手順では [、構成の生成、エクスポート、インポート、および複数のデバイスへの展開が含まれます](import-export-exploit-protection-emet-xml.md)。

> [!WARNING]
> 一部のセキュリティ軽減テクノロジでは、一部のアプリケーションとの互換性の問題が発生する可能性があります。運用環境またはネットワークの残りの部分に構成をデプロイする前に、[監査モード](evaluate-exploit-protection.md)を使用して、すべてのターゲット使用シナリオで悪用防止をテストする必要があります。

## <a name="exploit-protection-mitigations"></a>エクスプロイト保護の軽減策

すべての軽減策は、個々のアプリに対して構成できます。 一部の軽減策は、オペレーティング システム レベルでも適用できます。

各軽減策は、オン、オフ、または既定値に設定できます。 一部の軽減策には、表の説明に示されている追加のオプションがあります。

既定値は、各軽減策の **[既定値を使用** ] オプションで常に角かっこで囲んで指定されます。 次の例では、データ実行防止の既定値は "オン" です。

各軽減策設定の **[既定** の構成を使用する] は、ホーム ユーザーの日常的な使用に対する基本レベルの保護に関する推奨事項を示します。 Enterpriseデプロイでは、個々のニーズに必要な保護を考慮する必要があり、既定から離れた構成を変更する必要がある場合があります。

各軽減策に関連する PowerShell コマンドレットについては、この記事の下部にある [PowerShell リファレンス テーブル](#cmdlets-table) を参照してください。

|軽減策|説明|に適用できます。|使用できる監査モード|
|---|---|---|---|
|制御フロー ガード (CFG)|間接呼び出しの制御フローの整合性を確保します。 必要に応じてエクスポートを抑制し、厳密な CFG を使用できます。|システムレベルとアプリレベル|いいえ|
|データ実行防止 (DEP)|ヒープやスタックなどのデータのみのメモリ ページからコードを実行できないようにします。 32 ビット (x86) アプリでのみ構成可能で、他のすべてのアーキテクチャに対して永続的に有効になります。 必要に応じて、ATL サンク エミュレーションを有効にできます。|システムレベルとアプリレベル|いいえ|
|イメージのランダム化の強制 (必須 ASLR)|/DYNAMICBASE でコンパイルされていないイメージを強制的に再配置します。 必要に応じて、再配置情報がないイメージの読み込みに失敗する可能性があります。|システムレベルとアプリレベル|いいえ|
|メモリ割り当てのランダム化 (ボトムアップ ASLR)|仮想メモリ割り当ての場所をランダム化します。 これには、システム構造ヒープ、スタック、TEB、PEB が含まれます。 必要に応じて、64 ビット プロセスに対してより広範なランダム化分散を使用できます。|システムレベルとアプリレベル|いいえ|
|例外チェーンの検証 (SEHOP)|例外ディスパッチ中の例外チェーンの整合性を確保します。 32 ビット (x86) アプリケーションでのみ構成できます。|システムレベルとアプリレベル|不要|
|ヒープの整合性の検証|ヒープの破損が検出されたときにプロセスを終了します。|システムレベルとアプリレベル|いいえ|
|任意のコード ガード (ACG)|イメージにバックアップされていない実行可能コードの導入を防止し、コード ページが変更されないようにします。 必要に応じて、スレッドのオプトアウトを許可し、リモート ダウングレードを許可できます (PowerShell でのみ構成可能)。|アプリ レベルのみ|はい|
|整合性が低いイメージのブロック|低整合性でマークされたイメージの読み込みを防止します。|アプリ レベルのみ|はい|
|リモート イメージのブロック|リモート デバイスからのイメージの読み込みを防止します。|アプリ レベルのみ|いいえ|
|信頼されていないフォントのブロック|システム フォント ディレクトリにインストールされていない GDI ベースのフォント、特に Web からのフォントの読み込みを禁止します。|アプリ レベルのみ|はい|
|コードの整合性ガード|Microsoft、WHQL、またはそれ以降によって署名されたイメージの読み込みを制限します。 必要に応じて、署名されたイメージMicrosoft Store許可できます。|アプリ レベルのみ|はい|
|拡張ポイントの無効化|AppInit DLL、ウィンドウ フック、Winsock サービス プロバイダーなど、すべてのプロセスへの DLL インジェクションを許可するさまざまな機能拡張メカニズムを無効にします。|アプリ レベルのみ|不要|
|Win32k システム コールの無効化|アプリが Win32k システム呼び出しテーブルを使用できないようにします。|アプリ レベルのみ|はい|
|子プロセスを許可しない|アプリが子プロセスを作成できないようにします。|アプリ レベルのみ|はい|
|エクスポート アドレス フィルター (EAF)|悪意のあるコードによって解決されている危険な操作を検出します。 必要に応じて、悪用によって一般的に使用されるモジュールによるアクセスを検証できます。|アプリ レベルのみ|はい|
|インポート アドレス フィルター (IAF)|悪意のあるコードによって解決されている危険な操作を検出します。|アプリ レベルのみ|はい|
|実行のシミュレート (SimExec)|機密性の高い API の呼び出しが正当な呼び出し元に返されるようにします。 32 ビット (x86) アプリケーションでのみ構成できます。 ACG と互換性がありません。|アプリ レベルのみ|はい|
|API 呼び出しの検証 (CallerCheck)|機密性の高い API が正当な呼び出し元によって呼び出されるようにします。 32 ビット (x86) アプリケーションでのみ構成できます。 ACG と互換性がありません|アプリ レベルのみ|はい|
|ハンドルの使用状態の検証|無効なハンドル参照に対して例外が発生します。|アプリ レベルのみ|不要|
|軽減策の依存関係の整合性の検証|イメージの依存関係の読み込みWindowsコード署名を強制します。|アプリ レベルのみ|いいえ|
|スタックの整合性の検証 (StackPivot)|スタックが機密 API にリダイレクトされていないことを確認します。 ACG と互換性がありません。|アプリ レベルのみ|はい|

> [!IMPORTANT]
> **[プログラムの設定]** セクションにアプリを追加し、そこで個々の軽減策設定を構成すると、**システム** 設定セクションで指定したものと同じ軽減策の構成の上に適用されます。 次のマトリックスと例は、既定値のしくみを示すのに役立ちます。
>
>
> |**プログラム設定** で有効|**システム設定** で有効|動作|
> |---|---|---|
> |はい|いいえ|**プログラムの設定** で定義されているように|
> |はい|はい|**プログラムの設定** で定義されているように|
> |いいえ|はい|**システム設定** で定義されているように|
> |いいえ|はい|既定のオプションを **使用** するで定義されている既定値|
>
>
> - **例 1**
>
>    [**システム設定**] セクションの **[データ実行防止 ( DEP)]** は **、既定で [オフ]** に構成されます。
>
>    その後、そのアプリ *のtest.exe* を **[プログラムの設定]** セクションに追加します。 そのアプリのオプションの [ **データ実行防止 (DEP)]** で、[ **システム設定のオーバーライド** ] オプションを有効にし、スイッチを **[オン]** に設定します。 [ **プログラムの設定]** セクションに他のアプリは表示されません。
>
>    その結果、DEP は *test.exe* に対してのみ有効になります。 他のすべてのアプリには DEP が適用されません。
>
>
> - **例 2**
>
>    Josie では、[**システム設定**] セクションの **[データ実行防止 (DEP)]** が **既定でオフ** に構成されます。
>
>    次に、Josie によってアプリ *のtest.exe* が **[プログラムの設定]** セクションに追加されます。 そのアプリのオプションの [ **データ実行防止 (DEP)]** で、[ **システム設定のオーバーライド** ] オプションを有効にし、スイッチを **[オン]** に設定します。
>
>    Josie では、アプリ *のmiles.exe* も **[プログラムの設定]** セクションに追加され、 **コントロール フロー ガード (CFG)** が **[オン**] に構成されます。 DEP またはそのアプリのその他の軽減策について、[ **システム設定のオーバーライド]** オプションは有効にしません。
>
>    その結果、DEP が *test.exe* に対して有効になります。 DEP は、 *miles.exe* を含む他のアプリでは有効になりません。 CFG は *miles.exe* に対して有効になります。

> [!NOTE]
> この記事で問題が見つかった場合は、Windows Server/Windows クライアント パートナーに直接報告するか、お客様の国の Microsoft テクニカル サポート番号を使用できます。

### <a name="configure-system-level-mitigations-with-the-windows-security-app"></a>Windows セキュリティ アプリを使用してシステム レベルの軽減策を構成する

1. タスク バーでシールド アイコンを選択するか、Windows セキュリティのスタート メニューを検索して **、Windows セキュリティ アプリを** 開きます。

2. **[アプリ & ブラウザー コントロール**] タイル (または左側のメニュー バーのアプリ アイコン) を選択し、[**Exploit protection**] を選択します。

3. [ **システム設定]** セクションで、構成する軽減策を見つけて、次のいずれかを選択します。 **[プログラムの設定**] セクションで個別に構成されていないアプリでは、ここで構成されている設定が使用されます。
   - **既定では、** この軽減策は、アプリ固有の **プログラム設定** セクションでこの軽減策が設定されていないアプリに対して *有効になります*。
   - **既定ではオフ** - この軽減策がアプリ固有の **[プログラム設定**] セクションで設定されていないアプリでは、軽減策は *無効になります*
   - **既定値を使用する** - 軽減策は、Windows 10またはWindows 11インストールによって設定される既定の構成に応じて有効または無効になります。既定値 (**オン** または **オフ**) は、軽減策ごとに既定のラベルを **使用** するの横に常に指定されます

   > [!NOTE]
   > 一部の設定を変更すると、[ユーザー アカウント制御] ウィンドウが表示されることがあります。 管理者の資格情報を入力して設定を適用します。

   一部の設定を変更すると、再起動が必要になる場合があります。

4. 構成するすべてのシステム レベルの軽減策に対して、これを繰り返します。

5. **[プログラムの設定]** セクションに移動し、軽減策を適用するアプリを選択します。

   1. 構成するアプリが既に一覧表示されている場合は、それを選択し、[**編集]** を選択します。
   2. アプリが一覧にない場合は、一覧の上部にある [プログラムの追加] を選択 **してカスタマイズ** し、アプリを追加する方法を選択します。
      - **プログラム名で追加** を使用すると、その名前を持つ実行中のプロセスに軽減策が適用されます。 拡張子を持つファイルを指定する必要があります。 完全なパスを入力して、その場所にその名前を持つアプリのみに軽減策を制限できます。
      - 標準のWindows エクスプローラー のファイル ピッカー ウィンドウを使用して、目的のファイルを検索して選択するには、[**正確なファイル パス** の選択] を使用します。

6. アプリを選択すると、適用できるすべての軽減策の一覧が表示されます。 軽減策を有効にするには、チェック ボックスをオンにし、スライダーを **[オン]** に変更します。 その他のオプションを選択します。 **監査** を選択すると、監査モードでのみ軽減策が適用されます。 プロセスまたはアプリを再起動する必要がある場合、またはWindowsを再起動する必要がある場合は、通知が表示されます。

7. 構成するすべてのアプリと軽減策について、これらの手順を繰り返します。 構成の設定が完了したら、[ **適用]** を選択します。

[これらの設定を XML ファイルとしてエクスポートすることも、](import-export-exploit-protection-emet-xml.md)引き続きアプリ固有の軽減策を構成することもできます。

構成を XML ファイルとしてエクスポートすると、あるデバイスから他のデバイスに構成をコピーできます。

## <a name="powershell-reference"></a>PowerShell リファレンス

Windows セキュリティ アプリを使用して Exploit Protection を構成することも、PowerShell コマンドレットを使用することもできます。

PowerShell または Windows セキュリティのどちらを使用するかに関係なく、最後に変更された構成設定は常に適用されます。 つまり、アプリを使用して軽減策を構成した後、PowerShell を使用して同じ軽減策を構成すると、アプリが更新され、PowerShell で行った変更が表示されます。 その後、アプリを使用して軽減策を再度変更する場合は、その変更が適用されます。

> [!IMPORTANT]
> グループ ポリシーを介してデバイスに展開されるすべての変更は、ローカル構成をオーバーライドします。 初期構成を設定する場合は、グループ ポリシー構成が適用されていないデバイスを使用して、変更がオーバーライドされないようにします。

PowerShell 動詞 `Get` または `Set` コマンドレット `ProcessMitigation`を使用できます。 使用 `Get` すると、デバイスで有効になっている軽減策の現在の構成状態が一覧表示されます。コマンドレットとアプリの exe を追加 `-Name` して、そのアプリのみの軽減策を確認します。

```PowerShell
Get-ProcessMitigation -Name processName.exe
```

> [!IMPORTANT]
> 構成されていないシステム レベルの軽減策には、次の `NOTSET`状態が表示されます。
>
> システム レベルの設定では、 `NOTSET` その軽減策の既定の設定が適用されたことを示します。
>
> アプリ レベルの設定では、 `NOTSET` 軽減策のシステム レベルの設定が適用されることを示します。
>
> 各システム レベルの軽減策の既定の設定は、Windows セキュリティで確認できます。

各軽減策を次の形式で構成するために使用 `Set` します。

```PowerShell
Set-ProcessMitigation -<scope> <app executable> -<action> <mitigation or options>,<mitigation or options>,<mitigation or options>
```

ここで、

- \<Scope\>:
  - `-Name` を使用して、軽減策を特定のアプリに適用する必要があることを示します。 このフラグの後にアプリの実行可能ファイルを指定します。
  - `-System` システム レベルで軽減策を適用する必要があることを示す
- \<Action\>:
  - `-Enable` 軽減策を有効にする
  - `-Disable` 軽減策を無効にするには
- \<Mitigation\>:
  - 次の [軽減策コマンドレットの表に定義されている軽減策のコマンドレット](#cmdlets-table) と、サブオプション (スペースで囲まれています)。 各軽減策はコンマで区切られます。

たとえば、ATL サンク エミュレーションを使用してデータ実行防止 (DEP) 軽減策を有効にし、フォルダー *C:\Apps\LOB\tests**内のtesting.exe* という実行可能ファイルに対して有効にし、その実行可能ファイルが子プロセスを作成できないようにするには、次のコマンドを使用します。

```PowerShell
Set-ProcessMitigation -Name c:\apps\lob\tests\testing.exe -Enable DEP, EmulateAtlThunks, DisallowChildProcessCreation
```

> [!IMPORTANT]
> 各軽減策オプションをコンマで区切ります。

システム レベルで DEP を適用する場合は、次のコマンドを使用します。

```PowerShell
Set-Processmitigation -System -Enable DEP
```

軽減策を無効にするには、次に`-Disable`置き換えることができます`-Enable`。 ただし、アプリ レベルの軽減策の場合は、そのアプリに対してのみ軽減策が無効になります。

軽減策をシステムの既定値に戻す必要がある場合は、次の `-Remove` 例と同様にコマンドレットを含める必要があります。

```PowerShell
Set-Processmitigation -Name test.exe -Remove -Disable DEP
```

また、一部の軽減策を監査モードに設定することもできます。 軽減策に PowerShell コマンドレットを使用する代わりに、次の [軽減コマンドレットの表](#cmdlets-table)で指定されている **監査モード** コマンドレットを使用します。

たとえば、以前に使用した *testing.exe* の監査モードで任意の Code Guard (ACG) を有効にするには、次のコマンドを使用します。

```PowerShell
Set-ProcessMitigation -Name c:\apps\lob\tests\testing.exe -Enable AuditDynamicCode
```

監査モードを無効にするには、同じコマンドを使用しますが、次のコマンドに`-Enable``-Disable`置き換えます。

### <a name="powershell-reference-table"></a>PowerShell リファレンス テーブル

次の表に、各軽減策を構成するために使用できる PowerShell コマンドレット (および関連する監査モード コマンドレット) を示します。

<a id="cmdlets-table"></a>

|軽減策|適用対象|PowerShell コマンドレット|監査モードコマンドレット|
|---|---|---|---|
|制御フロー ガード (CFG)|システムレベルとアプリレベル|CFG、StrictCFG、SuppressExports|監査は使用できません|
|データ実行防止 (DEP)|システムレベルとアプリレベル|DEP、EmulateAtlThunks|監査は使用できません|
|イメージのランダム化の強制 (必須 ASLR)|システムレベルとアプリレベル|ForceRelocateImages|監査は使用できません|
|メモリ割り当てのランダム化 (ボトムアップ ASLR)|システムレベルとアプリレベル|BottomUp、HighEntropy|監査は使用できません|
|例外チェーンの検証 (SEHOP)|システムレベルとアプリレベル|SEHOP、SEHOPTelemetry|監査は使用できません|
|ヒープの整合性の検証|システムレベルとアプリレベル|TerminateOnError|監査は使用できません|
|任意のコード ガード (ACG)|アプリ レベルのみ|DynamicCode|AuditDynamicCode|
|整合性が低いイメージのブロック|アプリ レベルのみ|BlockLowLabel|AuditImageLoad|
|リモート イメージのブロック|アプリ レベルのみ|BlockRemoteImages|監査は使用できません|
|信頼されていないフォントのブロック|アプリ レベルのみ|DisableNonSystemFonts|AuditFont、FontAuditOnly|
|コードの整合性ガード|アプリ レベルのみ|BlockNonMicrosoftSigned、AllowStoreSigned|AuditMicrosoftSigned、AuditStoreSigned|
|拡張ポイントの無効化|アプリ レベルのみ|ExtensionPoint|監査は使用できません|
|Win32k システム コールの無効化|アプリ レベルのみ|DisableWin32kSystemCalls|AuditSystemCall|
|子プロセスを許可しない|アプリ レベルのみ|DisallowChildProcessCreation|AuditChildProcess|
|エクスポート アドレス フィルター (EAF)|アプリ レベルのみ|EnableExportAddressFilterPlus, EnableExportAddressFilter <a href="#r1" id="t1">\[1\]</a>|監査は使用できません<a href="#r2" id="t2">\[2\]</a>|
|インポート アドレス フィルター (IAF)|アプリ レベルのみ|EnableImportAddressFilter|監査は使用できません<a href="#r2" id="t2">\[2\]</a>|
|実行のシミュレート (SimExec)|アプリ レベルのみ|EnableRopSimExec|監査は使用できません<a href="#r2" id="t2">\[2\]</a>|
|API 呼び出しの検証 (CallerCheck)|アプリ レベルのみ|EnableRopCallerCheck|監査は使用できません<a href="#r2" id="t2">\[2\]</a>|
|ハンドルの使用状態の検証|アプリ レベルのみ|StrictHandle|監査は使用できません|
|軽減策の依存関係の整合性の検証|アプリ レベルのみ|EnforceModuleDepencySigning|監査は使用できません|
|スタックの整合性の検証 (StackPivot)|アプリ レベルのみ|EnableRopStackPivot|監査は使用できません<a href="#r2" id="t2">\[2\]</a>|

<a href="#t1" id="r1">\[1\]</a>: 次の形式を使用して、プロセスに対して dll の EAF モジュールを有効にします。

```PowerShell
Set-ProcessMitigation -Name processName.exe -Enable EnableExportAddressFilterPlus -EAFModules dllName1.dll,dllName2.dll
```

<a href="#t2" id="r2">\[2\]</a>: この軽減策の監査は、PowerShell コマンドレットでは使用できません。

## <a name="customize-the-notification"></a>通知をカスタマイズする

ルールがトリガーされ、アプリまたはファイルがブロックされたときに通知をカスタマイズする方法の詳細については、「[Windows セキュリティ](/windows/security/threat-protection/windows-defender-security-center/windows-defender-security-center)」を参照してください。

## <a name="see-also"></a>関連項目

- [エクスプロイトからデバイスを保護する](exploit-protection.md)
- [エクスプロイト保護を評価する](evaluate-exploit-protection.md)
- [エクスプロイト保護を有効にする](enable-exploit-protection.md)
- [エクスプロイト保護構成のインポート、エクスポート、展開](import-export-exploit-protection-emet-xml.md)
