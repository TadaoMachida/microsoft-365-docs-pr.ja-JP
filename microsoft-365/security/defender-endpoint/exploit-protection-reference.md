---
title: エクスプロイト保護のリファレンス
keywords: 軽減策、脆弱性、脆弱性、軽減策、エクスプロイト、攻略、emet
description: Windows でのエクスプロイト保護機能のしくみの詳細
ms.pagetype: security
ms.prod: m365-security
ms.mktglfcycl: manage
ms.sitesec: library
ms.localizationpriority: medium
audience: ITPro
author: denisebmsft
ms.author: deniseb
ms.reviewer: cjacks
manager: dansimp
ms.custom: asr
ms.technology: mde
ms.topic: article
ms.collection: m365-security-compliance
ms.date: 10/19/2021
ms.openlocfilehash: f6889cb12f1a152abe3dbb7d748d52e118547ab3
ms.sourcegitcommit: bdd6ffc6ebe4e6cb212ab22793d9513dae6d798c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/08/2022
ms.locfileid: "63324131"
---
# <a name="exploit-protection-reference"></a>Exploit Protection のリファレンス

[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]


**適用対象:**
- [Microsoft Defender for Endpoint Plan 2](https://go.microsoft.com/fwlink/?linkid=2154037)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

> Microsoft Defender ATP を試してみたいですか? [無料試用版にサインアップしてください。](https://signup.microsoft.com/create-account/signup?products=7f379fee-c4f9-4278-b0a1-e4c8c2fcdf7e&ru=https://aka.ms/MDEp2OpenTrial?ocid=docs-wdatp-enablesiem-abovefoldlink)

Exploit Protection は、開発者がソフトウェアをコンパイルして配布した後に IT 担当者が適用できるアプリケーションに対して高度な保護を提供します。

この記事では、ポリシー レベルと個々の軽減レベルの両方で、エクスプロイト保護がどのように機能するかを理解し、Exploit Protection ポリシーを正常に構築して適用するのに役立ちます。

## <a name="how-mitigations-are-applied"></a>軽減策の適用方法

Exploit Protection 軽減策は、アプリケーションごとに適用されます。

軽減策は、保護を構成するプログラムごとにレジストリ エントリを使用して構成されます。 これらの設定は、各プログラムの **MitigationOptions** レジストリ エントリに格納されます (**HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Image File Execution Options \ *ImageFileName* \ MitigationOptions**)。 これらは、プログラムを再起動したときに有効になり、変更してプログラムを再起動するまで有効なままになります。

> [!IMPORTANT]
> イメージ ファイル実行オプションでは、ファイル名またはパスのみを指定でき、バージョン番号、アーキテクチャ、またはその他の差別化要因は指定できません。 一意の名前またはパスを持つアプリに対する軽減策を対象とするように注意してください。そのバージョンをテストしたデバイスとそのアプリケーションのアーキテクチャにのみ適用します。

この XML 構成ファイルを処理するときに、PowerShell、グループ ポリシー、または MDM を使用して XML 構成ファイルを使用してエクスプロイト保護軽減策を構成すると、個々のレジストリ設定が構成されます。

XML ファイルを配布するポリシーが強制されなくなった場合、この XML 構成ファイルによってデプロイされた設定は自動的に削除されません。 Exploit Protection 設定を削除するには、クリーンな状態の Windows 10 または Windows 11 デバイスから XML 構成をエクスポートし、この新しい XML ファイルを展開します。 または、Microsoft が、Exploit Protection 設定をリセットするための Windows セキュリティ ベースラインの一部として XML ファイルを提供します。

PowerShell を使用して Exploit Protection の設定をリセットするには、次のコマンドを使用できます:

```powershell
Set-ProcessMitigation -PolicyFilePath EP-reset.xml
```
Windows セキュリティ ベースラインと共に配布される EP-reset.xml を次に示します:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<MitigationPolicy>
  <AppConfig Executable="ONEDRIVE.EXE">
    <DEP OverrideDEP="false" />
    <ASLR OverrideRelocateImages="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
    <ImageLoad OverrideBlockRemoteImages="false" />
  </AppConfig>
  <AppConfig Executable="firefox.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
  </AppConfig>
  <AppConfig Executable="fltldr.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
    <ImageLoad OverrideBlockRemoteImages="false" />
    <ChildProcess OverrideChildProcess="false" />
  </AppConfig>
  <AppConfig Executable="GROOVE.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
    <ImageLoad OverrideBlockRemoteImages="false" />
    <ChildProcess OverrideChildProcess="false" />
  </AppConfig>
  <AppConfig Executable="Acrobat.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="AcroRd32.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="chrome.exe">
    <DEP OverrideDEP="false" />
  </AppConfig>
  <AppConfig Executable="EXCEL.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="iexplore.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="INFOPATH.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="java.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="javaw.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="javaws.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="LYNC.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="MSACCESS.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="MSPUB.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="OIS.EXE">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="OUTLOOK.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="plugin-container.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="POWERPNT.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="PPTVIEW.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="VISIO.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="VPREVIEW.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="WINWORD.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="wmplayer.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="wordpad.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
</MitigationPolicy>
```

## <a name="mitigation-reference"></a>軽減策リファレンス

次のセクションでは、各エクスプロイト保護軽減策によって提供される保護、軽減策の互換性に関する考慮事項、および使用可能な構成オプションについて詳しく説明します。

## <a name="arbitrary-code-guard"></a>任意のコード ガード

### <a name="description"></a>説明

任意のコード ガードは、悪意のある攻撃者がメモリの安全性に関する脆弱性を通じて任意のコードをメモリに読み込み、そのコードを実行するのを防ぐのに役立ちます。

任意のコード ガードは、動的に生成されたコード (たとえば、exe 自体や dll から読み込まれないコード) を実行しないようにアプリケーションを保護します。 任意のコード ガードは、メモリが実行可能ファイルとしてマークされないようにすることで機能します。 アプリケーションが [メモリを割り当て](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)ようとすると、保護フラグがチェックされます。 (メモリは、読み取り、書き込み、または実行保護フラグを使用して割り当てられます)。割り当てに [*実行*](/windows/win32/memory/memory-protection-constants)保護フラグを含めようとすると、メモリ割り当てが失敗し、エラー コード (STATUS_DYNAMIC_CODE_BLOCKED) が返されます。 同様に、アプリケーションが既に割り当てられている [メモリの保護フラグを変更](/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect)しようとして、且つ [*実行*](/windows/win32/memory/memory-protection-constants)保護フラグが含まれている場合、アクセス許可の変更は失敗し、エラー コード (STATUS_DYNAMIC_CODE_BLOCKED) が返されます。

*実行* フラグが設定されないようにすることで、Windows 10 と Windows 11 のデータ実行防止機能は、そのメモリに設定され、命令ポインターがそのメモリーに設定され、コードが実行されるのを防ぎます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

任意のコード ガードにより、実行可能ファイルとしてメモリを割り当てることができなくなります。これにより、Just-In-Time (JIT) コンパイラなどの方法との互換性の問題が発生します。 たとえば、最新のブラウザーのほとんどは、パフォーマンスを最適化するために JavaScript をネイティブ コードにコンパイルします。 この軽減策をサポートするには、JIT コンパイルを保護されたプロセスの外部に移動するために再設計する必要があります。 スクリプトやその他の中間言語からコードを動的に生成する設計の他のアプリケーションは、同様にこの軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**スレッドのオプトアウトを許可** - 個々のスレッドがこの保護をオプトアウトできるように軽減策を構成できます。 開発者は、この軽減策を認識してアプリケーションを作成し、このスレッドで動的コードを実行できるようにするために、*ThreadInformation* パラメーターを **ThreadDynamicCodePolicy** に設定して [**SetThreadInformation**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadinformation) API を呼び出している必要があります。

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="block-low-integrity-images"></a>整合性が低いイメージのブロック

### <a name="description"></a>説明

[整合性の低いイメージのブロック] により、アプリケーションが信頼できないファイル（通常はサンドボックス化されたブラウザからインターネットにダウンロードされたもの）を読み込むことを防止します。

この軽減策では、イメージに低 IL プロセスへのアクセスを許可するアクセス制御エントリ (ACE) があり、信頼ラベル ACE がない場合、イメージの読み込みをブロックします。 これはメモリ マネージャーによって実装され、ファイルがメモリにマップされるのをブロックします。 アプリケーションが整合性の低いイメージをマップしようとすると、STATUS_ACCESS_DENIED エラーがトリガーされます。 整合性レベルのしくみの詳細については、「[必須の整合性コントロール](/windows/win32/secauthz/mandatory-integrity-control)」を参照してください。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

整合性の低いイメージをブロックすると、アプリケーションがインターネットからダウンロードされたファイルを読み込めなくなります。 アプリケーション ワークフローでダウンロードされたイメージの読み込みが必要な場合は、高信頼プロセスからダウンロードするか、この軽減策を適用するために明示的に再ラベル付けされるようにする必要があります。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="block-remote-images"></a>リモート イメージのブロック

### <a name="description"></a>説明

リモート イメージをブロックすると、アプリケーションが UNC 共有などのリモート デバイスでホストされているファイルを読み込むのを防ぐことができます。 リモート イメージをブロックすると、攻撃者が制御する外部デバイス上のバイナリをメモリ読み込むのを防ぐことができます。

この軽減策により、イメージがリモート デバイス上にあると判断された場合、イメージの読み込みはブロックされます。 これはメモリ マネージャーによって実装され、ファイルがメモリにマップされるのをブロックします。 アプリケーションがリモート ファイルをマップしようとすると、STATUS_ACCESS_DENIED エラーがトリガーされます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

[リモート イメージのブロック] により、アプリケーションがリモート デバイスからイメージを読み込めなくなります。 アプリケーションがリモート デバイスからファイルまたはプラグインを読み込む場合、この軽減策とは互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="block-untrusted-fonts"></a>信頼されていないフォントのブロック

### <a name="description"></a>説明

信頼されていないフォントをブロックすると、フォント解析の欠陥が軽減され、攻撃者がデバイスでコードを実行できるようになります。 windows\fonts ディレクトリにインストールされているフォントのみが GDI によって処理されるように読み込まれます。

この軽減策は GDI 内に実装され、ファイルの場所が検証されます。 ファイルがシステム フォント ディレクトリにない場合、フォントは解析用に読み込まれず、その呼び出しは失敗します。

この軽減策は、Windows 10 1607 以降で提供される組み込みの軽減策と、フォント解析をカーネルからユーザー モード アプリ コンテナーに移動させる Windows 11 に加えて行われます。 その結果、フォント解析に基づくエクスプロイトは、サンドボックス化され分離されたコンテキストで発生するため、リスクが大幅に軽減されます。 この軽減策の詳細については、「[ゼロ デイ エクスプロイトの軽減策で Windows 10 のセキュリティを強化](https://www.microsoft.com/security/blog/2017/01/13/hardening-windows-10-with-zero-day-exploit-mitigations/)」のブログを参照してください。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

システム フォント ディレクトリ以外でのフォントの最も一般的な用途は、 [Web フォント](/typography/fonts/font-faq#web)です。 Microsoft Edge などの最新のブラウザーでは、GDI ではなく DirectWrite を使用しますが、影響を受けません。 ただし、Internet Explorer 11 (および新しい Microsoft Edge の IE モード) などの従来のブラウザーは影響を受ける可能性があります。特に、フォント グリフを使用して UI を表示する Office 365 などのアプリケーションでは影響を受ける可能性があります。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="code-integrity-guard"></a>コードの整合性ガード

### <a name="description"></a>説明

コード整合性ガードを使用すると、プロセスに読み込まれるすべてのバイナリが Microsoft によってデジタル署名されます。 コード整合性ガードには [WHQL](/windows-hardware/drivers/install/whql-release-signature) (Windows Hardware Quality Labs) 署名が含まれており、WHQL で承認されたドライバーをプロセス内で実行できます。

この軽減策はメモリ マネージャー内に実装され、バイナリがメモリにマップされるのをブロックします。 Microsoft によって署名されていないバイナリを読み込もうとすると、メモリ マネージャーはエラー STATUS_INVALID_IMAGE_HASH を返します。 メモリ マネージャー レベルでブロックすることで、プロセスによって読み込まれるバイナリと、プロセスに挿入されたバイナリの両方を防ぐことができます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、Microsoft によって署名されていないバイナリを特にブロックします。 そのため、ソフトウェアが Microsoft Store によって配布 (およびデジタル署名) され、Microsoft Store によって署名されたイメージの読み込みを許可するオプションが選択されている場合を除き、ほとんどのサード パーティ製ソフトウェアと互換性がありません。

### <a name="configuration-options"></a>構成オプション

**また、Microsoft Store によって署名されたイメージの読み込みを許可** - Microsoft Store によって配布されるアプリケーションは、Microsoft Store によってデジタル署名されます。この構成を追加すると、Store 認定プロセスを通過したバイナリをアプリケーションによって読み込むことができます。

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="control-flow-guard-cfg"></a>制御フロー ガード (CFG)

### <a name="description"></a>説明

制御フロー ガード (CFG) は、間接関数呼び出しを保護することで、メモリ破損の脆弱性を使用する攻撃者のリスクを軽減します。 たとえば、攻撃者はバッファー オーバーフローの脆弱性を使用して、関数ポインターを含むメモリを上書きし、その関数ポインターを任意の実行可能コードへのポインター (プログラムにも挿入されている可能性があります) に置き換える可能性があります。

この軽減策は、コンパイル時に別のチェックを挿入することによって提供されます。 各間接関数呼び出しの前に、ターゲットが呼び出される前に有効な呼び出し先であることを確認する別の命令が追加されます。 ターゲットが有効な呼び出し先でない場合、アプリケーションは終了されます。 そのため、この軽減策のメリットを得ることができるのは、CFG サポートでコンパイルされたアプリケーションのみです。

有効なターゲットのチェックは、Windows カーネルによって提供されます。 実行可能ファイルが読み込まれると、間接呼び出しターゲットのメタデータが読み込み時に抽出され、有効な呼び出し先としてマークされます。 さらに、メモリが割り当てられ、実行可能ファイルとしてマークされている場合 (生成されたコード用など)、これらのメモリの場所は、JIT コンパイルなどのメカニズムをサポートするために、有効な呼び出しターゲットとしてもマークされます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

アプリケーションは CFG をサポートするようにコンパイルする必要があるため、アプリケーションとの互換性を暗黙的に宣言します。 そのため、ほとんどのアプリケーションは、この軽減策を有効にした状態で動作する必要があります。 これらのチェックはバイナリにコンパイルされるため、適用できる構成は、単に Windows カーネル内のチェックを無効にすることです。 つまり、軽減策は既定でオンになっていますが、後でアプリケーション開発者がテストで検出しなかった互換性の問題があると判断した場合は、常に "はい" を返すように Windows カーネルを構成できます。これはまれです。

### <a name="configuration-options"></a>構成オプション

**strict CFG の使用** - 厳密モードでは、プロセスに読み込まれるすべてのバイナリを読み込むには、制御フロー ガード用にコンパイルする必要があります (または、リソース dll などの実行可能コードがありません)。

> [!Note]
> **制御フロー ガード** には監査モードがありません。 バイナリは、この軽減策を有効にした状態でコンパイルされます。

## <a name="data-execution-prevention-dep"></a>データ実行防止 (DEP)

### <a name="description"></a>説明

データ実行防止 (DEP) により、実行可能ファイルとして明示的に割り当てられていたメモリが実行されなくなります。 DEP は、バッファー オーバーフローなどのプロセスに悪意のあるコードを挿入し、そのコードを実行する攻撃者から保護するのに役立ちます。

実行可能ファイルとしてマークされていないメモリ アドレスに命令ポインターを設定しようとすると、プロセッサは例外 (一般的な保護違反) をスローし、アプリケーションがクラッシュします。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

すべての x64、ARM、ARM-64 実行可能ファイルは既定で DEP が有効になっており、無効にすることはできません。 DEP なしでアプリケーションが実行されることはないため、互換性が想定されます。

すべての x86 (32 ビット) バイナリでは既定で DEP が有効になっていますが、DEP はプロセスごとに無効にすることができます。 一部の古いレガシ アプリケーション (通常は Windows XP SP2 より前に開発されたアプリケーション) は DEP と互換性がない可能性があります。 このようなアプリケーションは通常、コードを動的に生成するか (JIT コンパイルなど)、またはコードを動的に生成する古いライブラリ (古いバージョンの ATL など) にリンクします。

### <a name="configuration-options"></a>構成オプション

**ATL サンク エミュレーションを有効にする** - この構成オプションは、ATL サンク エミュレーションを無効にします。 ActiveX テンプレート ライブラリ (ATL) は、できるだけ小さく高速に設計されています。 バイナリ サイズを小さくするために、 *サンキング* と呼ばれる手法を使用します。 サンキングは通常、32 ビットアプリケーションと 16 ビット アプリケーションの間で対話することを考えますが、ここでは ATL への 16 ビット コンポーネントはありません。 代わりに、バイナリ サイズを最適化するために、ATL は、ワード アラインされていないメモリにマシン コードを格納し (より小さいバイナリを作成する)、そのコードを直接呼び出します。 Visual Studio 7.1 以前 (Visual Studio 2003) でコンパイルされた ATL コンポーネントは、実行可能ファイルとしてこのメモリを割り当てません。サンク エミュレーションは、その互換性の問題を解決します。 バイナリ拡張モデル (Internet Explorer 11 など) を持つアプリケーションでは、多くの場合、ATL サンク エミュレーションを有効にする必要があります。

## <a name="disable-extension-points"></a>拡張ポイントの無効化

### <a name="description"></a>説明

この軽減策は、アプリケーションのさまざまな拡張ポイントを無効にします。これは、悪意のあるコンテンツの永続化の確立や特権の昇格に使用される可能性があります。

保持されるデータには以下が含まれます。

- **AppInit DLL** - プロセスが開始されるたびに、エントリ ポイント関数を呼び出す前に、指定した DLL が新しく開始されたプロセスのコンテキストに読み込まれます。 [AppInit DLL の詳細については、こちらを参照してください](/windows/win32/winmsg/about-window-classes#application-global-classes)。 この軽減策を適用すると、AppInit DLL は読み込まれません。 Windows 7 以降では、 [ここで説明するように](/windows/win32/win7appqual/appinit-dlls-in-windows-7-and-windows-server-2008-r2)、AppInit DLL をデジタル署名する必要があります。 さらに、Windows 8 以降では、 [ここで説明するように](/windows/win32/dlls/secure-boot-and-appinit-dlls) SecureBoot が有効になっている場合、AppInit DLL は読み込まれません。
- **従来の IME** - 入力方式エディター (IME) を使用すると、ユーザーはキーボードで表現しきれないほどの数の文字を使う言語で、テキストを入力することができます。 サードパーティが IME を作れます。 悪意のある IME は、この入力キャプチャから資格情報やその他の機密情報を取得する可能性があります。 レガシ IME と呼ばれる一部の IME は、UWP アプリではなく、Windows デスクトップ アプリでのみ動作します。 この軽減策により、このレガシ IME が指定された Windows デスクトップ アプリに読み込めなくなります。
- **Windows イベント フック** - アプリケーションは [SetWinEventHook API](/windows/win32/api/winuser/nf-winuser-setwineventhook) を呼び出して、発生したイベントに関心を登録できます。 DLL が指定されており、プロセスに挿入できます。 この軽減策では、挿入された DLL を介してプロセス内で実行するのではなく、フックを登録プロセスに強制的にポストします。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

これらの拡張ポイントのほとんどは使用される頻度が比較的に低いので、互換性への影響は通常、特に個々のアプリケーション レベルで小さくなります。 1 つの考慮事項は、ユーザーが保護されたアプリケーションで動作しないサード パーティのレガシ IME を使用している場合です。

### <a name="configuration-options"></a>構成オプション

この軽減策の構成オプションはありません。

> [!Note]
> **拡張ポイントの無効化** には監査モードはありません。

## <a name="disable-win32k-system-calls"></a>Win32k システム コールの無効化

### <a name="description"></a>説明

Win32k.sys は、攻撃者に広範な攻撃面を提供します。 カーネル モード コンポーネントとして、サンドボックス化されたアプリケーションのエスケープ ベクターとして頻繁にターゲットにされます。 この軽減策は、スレッドが GUI スレッドに変換され、Win32k 関数を呼び出すことができるようになるのをブロックすることで、Win32k.sysへの呼び出しを防止します。 スレッドは、作成時は非 GUI ですが、win32k.sys への最初の呼び出し、または [IsGuiThread](/windows/win32/api/winuser/nf-winuser-isguithread) への API 呼び出しによって変換されます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、専用の非 UI プロセスであるプロセス向けに設計されています。 たとえば、多くの最新のブラウザーでは、プロセス分離が使用され、UI 以外のプロセスが組み込まれます。 1 つのプロセスを使用して GUI を表示するすべてのアプリケーションは、この軽減策の影響を受けます。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="do-not-allow-child-processes"></a>子プロセスを許可しない

### <a name="description"></a>説明

この軽減策により、アプリケーションが新しい子アプリケーションを作成できなくなります。 攻撃者が使用する一般的な手法は、悪意のある入力 ("地外に住んでいる" 攻撃) を使用してデバイス上で信頼されたプロセスを開始することです。多くの場合、デバイスで別のアプリケーションの起動が必要になります。 アプリケーションに子プロセスを起動する正当な理由がない場合、この軽減策は潜在的な攻撃ベクトルを軽減します。 軽減策は、プロセス トークンにプロパティを設定することによって適用されます。これにより、子プロセスのトークンの作成がエラー メッセージ STATUS_CHILD_PROCESS_BLOCKED でブロックされます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

ブラウザーや外部ブラウザーを起動するハイパーリンクやコンピューター上の他のユーティリティを起動するハイパーリンクのサポートなど、何らかの理由でアプリケーションが子アプリケーションを起動した場合、この機能は、この軽減策が適用された状態で破損します。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="export-address-filtering"></a>エクスポート アドレス フィルター (EAF)

### <a name="description"></a>説明

エクスポート アドレス フィルター (EAF) は、読み込まれたすべてのモジュールのエクスポート アドレス テーブルを調べて、攻撃に役立つ API を含むモジュールを見つける悪意のあるコードのリスクを軽減します。 これはシェルコードで使用される一般的な戦術です。 このような攻撃のリスクを軽減するために、この軽減策は、一般的に攻撃される 3 つのモジュールを保護します:

- ntdll.dll
- kernelbase.dll
- kernel32.dll

軽減策は、[[エクスポート アドレス テーブル](/windows/win32/debug/pe-format#export-address-table)をポイントするエクスポート ディレクトリ] のメモリ ページを保護します。 このメモリ ページには、[PAGE_GUARD](/windows/win32/memory/creating-guard-pages) 保護が適用されます。 誰かがこのメモリにアクセスしようとすると、STATUS_GUARD_PAGE_VIOLATION が生成されます。 軽減策によってこの例外が処理され、アクセス命令が検証に合格しない場合、プロセスは終了されます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、主に、デバッガー、サンドボックス化されたアプリケーション、DRM を使用するアプリケーション、またはデバッグ対策テクノロジを実装するアプリケーションなどのアプリケーションにとって問題となります。

### <a name="configuration-options"></a>構成オプション

**エクスプロイトによって一般的に悪用されるモジュールのアクセスを検証する** - このオプション (EAF+ とも呼ばれます) は、他の一般的に攻撃されるモジュールの保護を追加します:

- `mshtml.dll`
- `flash*.ocx`
- `jscript*.ocx`
- `vbscript.dll`
- `vgx.dll`
- `mozjs.dll`
- `xul.dll`
- `acrord32.dll`
- `acrofx32.dll`
- `acroform.api`

さらに、EAF+ を有効にすることで、この軽減策により、"MZ" ヘッダー ([PE ファイル内の DOS ヘッダー](/windows/win32/debug/pe-format#ms-dos-stub-image-only)の最初の 2 バイト) を含むページに PAGE_GUARD 保護が追加されます。これは、シェルコードがメモリに関心を持つ可能性のあるモジュールを識別するために検索できる既知のメモリ コンテンツのもう 1 つの側面です。

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="force-randomization-for-images-mandatory-aslr"></a>イメージのランダム化の強制 (必須 ASLR)

### <a name="description"></a>説明

アドレス空間レイアウト ランダム化 (ASLR) は、プロセス メモリに既に存在し、既に実行可能としてマークされているコードを実行するために、システムのメモリ レイアウトに関する知識を使用して攻撃者のリスクを軽減します。 これにより、攻撃者が return-to-libc 攻撃などの手法を使用して、攻撃者のリスクを軽減できます。攻撃者はコンテキストを設定し、戻りアドレスを変更して、攻撃者の目的に合ったコンテキストで既存のコードを実行します。

必須 ASLR は、プロセス内のすべての DLL のリベースを強制します。 開発者は [/DYNAMICBASE](/cpp/build/reference/dynamicbase-use-address-space-layout-randomization) リンカー オプションを使用して ASLR を有効にすることができ、この軽減策にも同じ効果があります。

メモリ マネージャーがイメージ内でプロセスにマッピングされている場合、必須 ASLR は、ASLR にオプトインしていない DLL と EXE を強制的にリベースします。 ただし、この再調整にはエントロピがないため、メモリ内の予測可能な場所に配置できることに注意してください。 バイナリのリベースとランダム化された場所の場合、この軽減策は [ランダム化メモリ割り当て (Bottom-up ASLR)](#randomize-memory-allocations-bottom-up-aslr) と組み合わせて使用する必要があります。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

ASLR のこの互換性への影響は、通常、バイナリ ファイルのベース アドレスに関する想定を行ったコンパイラを使用して構築された古いアプリケーション、またはベース再配置情報を削除した古いアプリケーションに制限されます。 これにより、実行フローがメモリ内の実際の場所ではなく、予期された場所にジャンプしようとするので、予期しないエラーが発生する可能性があります。

### <a name="configuration-options"></a>構成オプション

**削除されたイメージを許可しない** - このオプションは、再配置情報が削除されたイメージの読み込みをブロックします。 Windows PE ファイル形式には絶対アドレスが含まれており、コンパイラは [ベース再配置テーブル] も生成します。このテーブルは、ローダーがすべての相対メモリ参照とそのオフセットを検索するために使用できるため、バイナリが優先ベース アドレスで読み込まれない場合に更新できます。 一部の古いアプリケーションでは、運用環境のビルドでこの情報を取り除くので、これらのバイナリを再ベースすることはできません。 この軽減策により、このようなバイナリの読み込みがブロックされます (優先ベース アドレスで読み込むことが許可されるのではなく)。

> [!Note]
> **イメージの強制的なランダム化 (必須 ASLR)** には監査モードがありません。

## <a name="import-address-filtering-iaf"></a>インポート アドレス フィルター (IAF)

### <a name="description"></a>説明

インポート アドレス フィルター (IAF) の軽減策は、インポート アドレス テーブル (IAT) を変更し、その関数が呼び出されたときに攻撃者が選択した任意のコードにリダイレクトすることで、攻撃者がアプリケーションの制御フローを変更するリスクを軽減するのに役立ちます。 攻撃者は、このアプローチで制御をハイジャックしたり、機密性の高い API の呼び出しを傍受、検査、ブロックしたりする可能性があります。

保護されているすべての API のメモリ ページには、[PAGE_GUARD](/windows/win32/memory/creating-guard-pages) 保護が適用されます。 誰かがこのメモリにアクセスしようとすると、STATUS_GUARD_PAGE_VIOLATION が生成されます。 軽減策によってこの例外が処理され、アクセス命令が検証に合格しない場合、プロセスは終了されます。

この軽減策は、次の Windows API を保護します:

- `GetProcAddress`
- `GetProcAddressForCaller`
- `LoadLibraryA`
- `LoadLibraryExA`
- `LoadLibraryW`
- `LoadLibraryExW`
- `LdrGetProcedureAddress`
- `LdrGetProcedureAddressEx`
- `LdrGetProcedureAddressForCaller`
- `LdrLoadDll`
- `VirtualProtect`
- `VirtualProtectEx`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `NtProtectVirtualMemory`
- `CreateProcessA`
- `CreateProcessW`
- `WinExec`
- `CreateProcessAsUserA`
- `CreateProcessAsUserW`
- `GetModuleHandleA`
- `GetModuleHandleW`
- `RtlDecodePointer`
- `DecodePointer`

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

API インターセプトを実行する正当なアプリケーションは、この軽減策によって検出され、一部のアプリケーションがクラッシュする可能性があります。 たとえば、セキュリティ ソフトウェアとアプリケーションの互換性の shim があります。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="randomize-memory-allocations-bottom-up-aslr"></a>仮想メモリの割り当てをランダム化する (ボトムアップ ASLR)

### <a name="description"></a>説明

メモリ割り当てをランダム化 (Bottom-up ASLR) すると、再配置にエントロピが追加されるため、その場所はランダム化されるため、予測不可能になります。 この軽減策を有効にするには、必須の ASLR が必要です。

32 ビット アドレス空間のサイズは、追加できるエントロピに実用的な制約があるため、64 ビット アプリケーションでは、攻撃者がメモリ内の場所を推測することがより困難になります。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

必須 ASLR (リベース) と互換性のあるほとんどのアプリケーションは、Bottom-up ASLR の他のエントロピとも互換性があります。 一部のアプリケーションでは、ローカル ポインターを 32 ビット変数に保存している場合 (ベース アドレスが 4 GB 未満である必要があります)、ポインターの切り捨ての問題が発生する可能性があるため、高エントロピ オプションと互換性がありません (これは無効にすることができます)。

### <a name="configuration-options"></a>構成オプション

**高エントロピを使用しない** - このオプションでは、64 ビット アプリケーションの下位割り当てに 24 ビットのエントロピ (1 TB の分散) を追加する高エントロピ ASLR の使用が無効になります。

> [!Note]
> **メモリ割り当てのランダム化 (ボトムアップ ASLR)** には監査モードはありません。

## <a name="simulate-execution-simexec"></a>実行のシミュレート (SimExec)

### <a name="description"></a>説明

実行のシミュレーション (SimExec) は、32 ビット アプリケーションのみの軽減策です。 これは、機密性の高い API の呼び出しが正当な呼び出し元関数に戻されることを検証するのに役立ちます。 これは、機密性の高い API の呼び出しを傍受し、エンコードされたアセンブリ言語命令を走査して呼び出し元に戻るべき RET 命令を探すことで、これらの API の実行をシミュレートします。 次に、その関数を検査し、メモリ内を後方に移動して、前の CALL 命令を見つけて、関数と CALL 命令が一致するかどうか、および RET が傍受されていないことを判断します。

この軽減策によってインターセプトされる API は次のとおりです。

- `LoadLibraryA`
- `LoadLibraryW`
- `LoadLibraryExA`
- `LoadLibraryExW`
- `LdrLoadDll`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `VirtualProtect`
- `VirtualProtectEx`
- `NtProtectVirtualMemory`
- `HeapCreate`
- `RtlCreateHeap`
- `CreateProcessA`
- `CreateProcessW`
- `CreateProcessInternalA`
- `CreateProcessInternalW`
- `NtCreateUserProcess`
- `NtCreateProcess`
- `NtCreateProcessEx`
- `CreateRemoteThread`
- `CreateRemoteThreadEx`
- `NtCreateThreadEx`
- `WriteProcessMemory`
- `NtWriteVirtualMemory`
- `WinExec`
- `CreateFileMappingA`
- `CreateFileMappingW`
- `CreateFileMappingNumaW`
- `NtCreateSection`
- `MapViewOfFile`
- `MapViewOfFileEx`
- `MapViewOfFileFromApp`
- `LdrGetProcedureAddressForCaller`

ROP ガジェットが検出されると、プロセスは終了します。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

API インターセプト (特にセキュリティ ソフトウェア) を実行するアプリケーションは、この軽減策との互換性の問題を引き起こす可能性があります。

この軽減策は、任意のコード カード軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="validate-api-invocation-callercheck"></a>API 呼び出しの検証 (CallerCheck)

### <a name="description"></a>説明

API 検証呼び出し (CallerCheck) は、有効な呼び出し元から機密性の高い API が呼び出されたことを検証するリターン指向プログラミング (ROP) 手法の軽減策です。 この軽減策は、渡されたリターン アドレスを検査し、ヒューリスティックに逆アセンブルして戻りアドレスの上の呼び出しを検索し、呼び出しターゲットが関数に渡されたパラメーターと一致するかどうかを判断します。

この軽減策によってインターセプトされる API は次のとおりです。

- `LoadLibraryA`
- `LoadLibraryW`
- `LoadLibraryExA`
- `LoadLibraryExW`
- `LdrLoadDll`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `VirtualProtect`
- `VirtualProtectEx`
- `NtProtectVirtualMemory`
- `HeapCreate`
- `RtlCreateHeap`
- `CreateProcessA`
- `CreateProcessW`
- `CreateProcessInternalA`
- `CreateProcessInternalW`
- `NtCreateUserProcess`
- `NtCreateProcess`
- `NtCreateProcessEx`
- `CreateRemoteThread`
- `CreateRemoteThreadEx`
- `NtCreateThreadEx`
- `WriteProcessMemory`
- `NtWriteVirtualMemory`
- `WinExec`
- `CreateFileMappingA`
- `CreateFileMappingW`
- `CreateFileMappingNumaW`
- `NtCreateSection`
- `MapViewOfFile`
- `MapViewOfFileEx`
- `MapViewOfFileFromApp`
- `LdrGetProcedureAddressForCaller`

ROP ガジェットが検出されると、プロセスは終了します。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

API インターセプト (特にセキュリティ ソフトウェア) を実行するアプリケーションは、この軽減策との互換性の問題を引き起こす可能性があります。

この軽減策は、任意のコード カード軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="validate-exception-chains-sehop"></a>例外チェーンの検証 (SEHOP)

### <a name="description"></a>説明

例外チェーンの検証 (SEHOP) は、*構造化例外ハンドラー (SEH) 上書き* 悪用手法に対する軽減策です。 [構造化例外処理](/windows/win32/debug/structured-exception-handling) は、アプリケーションが特定の例外の処理を要求できるプロセスです。 例外ハンドラーは連結されるため、1 つの例外ハンドラーが特定の例外を処理しないことを選択した場合は、処理が決定されるまで、チェーン内の次の例外ハンドラーに渡すことができます。 ハンドラーのリストは動的であるため、スタックに格納されます。 攻撃者はスタック オーバーフローの脆弱性を使用して、攻撃者が選択したコードへのポインターで例外ハンドラーを上書きできます。

この軽減策は、SEH の設計に依存します。各 SEH エントリには、例外ハンドラーへのポインターと、例外チェーン内の次のハンドラーへのポインターの両方が含まれます。 この軽減策は例外ディスパッチャーによって呼び出され、例外が呼び出されたときに SEH チェーンが検証されます。 次のことを確認します:

- すべての例外チェーン レコードがスタック境界内にある
- すべての例外レコードがアラインされている
- スタックを指している例外ハンドラー ポインターがない
- 後方ポインターがない
- 例外チェーンは既知の最終例外ハンドラーで終了する

これらの検証が失敗した場合、例外処理は中止され、例外は処理されません。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

SEHOP との互換性の問題は比較的まれです。 アプリケーションが例外チェーンの破損に依存することは珍しいことではありません。 ただし、一部のアプリケーションはタイミングの微妙な変化の影響を受けます。これは、アプリケーションの潜在的なマルチスレッド バグを明らかにする競合状態として現れる可能性があります。

### <a name="configuration-options"></a>構成オプション

> [!Note]
> **例外チェーンの検証 (SEHOP)** には監査モードはありません。

## <a name="validate-handle-usage"></a>ハンドルの使用状態の検証

### <a name="description"></a>説明

*ハンドルの使用の検証* は、既存のハンドルを使用して保護されたオブジェクトにアクセスする攻撃者に対する保護に役立つ軽減策です。 [ハンドル](/windows/win32/sysinfo/handles-and-objects)は、保護されたオブジェクトへの参照です。 アプリケーション コードが無効なハンドルを参照している場合、それは敵が以前に記録したが、(アプリケーションの参照カウントでは気づかない) ハンドルを使おうとしていることを示す可能性があります。 アプリケーションが単に null 値を返すのではなく、無効なオブジェクトを使用しようとすると、アプリケーションは例外を発生させます (STATUS_INVALID_HANDLE)。

この軽減策は、Windows Store アプリケーションに自動的に適用されます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

ハンドル参照を正確に追跡せず、例外ハンドラーでこれらの操作をラップしていないアプリケーションは、この軽減策の影響を受ける可能性があります。

### <a name="configuration-options"></a>構成オプション

> [!Note]
> **ハンドルの使用の検証** には監査モードはありません。

## <a name="validate-heap-integrity"></a>ヒープの整合性の検証

### <a name="description"></a>説明

*ヒープ整合性の検証* の軽減策では、ヒープの破損が検出された場合にアプリケーションを終了させることで、Windows でのヒープ軽減策の保護レベルが向上します。 軽減策には次のものが含まれます:

- HEAP ハンドルが解放されないようにする
- ヒープ割り当ての拡張ブロック ヘッダーに対して別の検証を実行する
- ヒープ割り当てに使用中のフラグがまだ設定されていないことの確認
- 大きな割り当て、ヒープ セグメント、最小サイズ以上のサブセグメントへのガード ページへの追加

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、64 ビット アプリケーションと、Windows Vista 以降を対象とする 32 ビット アプリケーションに対して、既定で既に適用されています。 Windows XP 以前のレガシ アプリケーションは最も危険にさらされますが、互換性の問題はまれです。

### <a name="configuration-options"></a>構成オプション

> [!Note]
> **ヒープ整合性の検証** には監査モードがありません。

## <a name="validate-image-dependency-integrity"></a>軽減策の依存関係の整合性の検証

### <a name="description"></a>説明

*イメージの依存関係の検証* の軽減策は、Windows バイナリによって静的にリンクされている dll のコードを置き換えようとする攻撃から保護するのに役立ちます。 DLL 植え付けの手法は、ローダーの検索メカニズムを悪用して悪意のあるコードを注入し、昇格したコンテキストで悪意のあるコードを実行させるために使用される可能性があります。 ローダーが Windows 署名付きバイナリを読み込み、バイナリが依存するすべての dll を読み込むと、これらのバイナリも Windows バイナリとしてデジタル署名されていることを確認します。 署名チェックに失敗した場合、dll は読み込まれず、例外がスローされ、STATUS_INVALID_IMAGE_HASH 状態が返されます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

互換性の問題は一般的ではありません。 Windows バイナリをローカル プライベート バージョンに置き換えることに依存するアプリケーションは、影響を受け、マルチスレッド アプリケーションで微妙なタイミング バグが明らかになるリスクも小さくなります。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。

## <a name="validate-stack-integrity-stackpivot"></a>スタックの整合性の検証 (StackPivot)

### <a name="description"></a>説明

*スタック整合性の検証 (StackPivot)* 軽減策は、スタック ピボット攻撃から保護するのに役立ちます。これは、攻撃者がヒープ メモリに偽のスタックを作成し、実行のフローを制御する偽のスタックに戻るようにアプリケーションを誘導する ROP 攻撃です。

この軽減策は、多くの Windows API を傍受し、スタック ポインターの値を検査します。 スタック ポインターのアドレスがスタックの下部と上部の間にない場合、イベントが記録され、監査モードでない場合はプロセスが終了します。

この軽減策によってインターセプトされる API は次のとおりです。

- `LoadLibraryA`
- `LoadLibraryW`
- `LoadLibraryExA`
- `LoadLibraryExW`
- `LdrLoadDll`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `VirtualProtect`
- `VirtualProtectEx`
- `NtProtectVirtualMemory`
- `HeapCreate`
- `RtlCreateHeap`
- `CreateProcessA`
- `CreateProcessW`
- `CreateProcessInternalA`
- `CreateProcessInternalW`
- `NtCreateUserProcess`
- `NtCreateProcess`
- `NtCreateProcessEx`
- `CreateRemoteThread`
- `CreateRemoteThreadEx`
- `NtCreateThreadEx`
- `WriteProcessMemory`
- `NtWriteVirtualMemory`
- `WinExec`
- `CreateFileMappingA`
- `CreateFileMappingW`
- `CreateFileMappingNumaW`
- `NtCreateSection`
- `MapViewOfFile`
- `MapViewOfFileEx`
- `MapViewOfFileFromApp`
- `LdrGetProcedureAddressForCaller`

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

偽のスタックを使用しているアプリケーションは影響を受け、マルチスレッド アプリケーションで微妙なタイミングバグが明らかにされるリスクも小さくなります。
API インターセプト (特にセキュリティ ソフトウェア) を実行するアプリケーションは、この軽減策との互換性の問題を引き起こす可能性があります。

この軽減策は、任意のコード カード軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、 [Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) の高度な追求を使用して表示することもできます。
