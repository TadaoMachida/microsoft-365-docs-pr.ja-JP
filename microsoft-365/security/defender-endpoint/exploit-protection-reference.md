---
title: エクスプロイト保護のリファレンス
keywords: 軽減策、脆弱性、脆弱性、軽減策、エクスプロイト、攻略、emet
description: Windowsでのエクスプロイト保護機能のしくみの詳細
ms.pagetype: security
ms.prod: m365-security
ms.mktglfcycl: manage
ms.sitesec: library
ms.localizationpriority: medium
audience: ITPro
author: denisebmsft
ms.author: deniseb
ms.reviewer: cjacks
manager: dansimp
ms.custom: asr
ms.technology: mde
ms.topic: article
ms.collection: m365-security-compliance
ms.date: 10/19/2021
ms.openlocfilehash: f6889cb12f1a152abe3dbb7d748d52e118547ab3
ms.sourcegitcommit: bdd6ffc6ebe4e6cb212ab22793d9513dae6d798c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/08/2022
ms.locfileid: "63324131"
---
# <a name="exploit-protection-reference"></a>Exploit Protection リファレンス

[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]


**適用対象:**
- [Microsoft Defender for Endpoint Plan 2](https://go.microsoft.com/fwlink/?linkid=2154037)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

> Microsoft Defender ATP を試してみたいですか? [無料試用版にサインアップしてください。](https://signup.microsoft.com/create-account/signup?products=7f379fee-c4f9-4278-b0a1-e4c8c2fcdf7e&ru=https://aka.ms/MDEp2OpenTrial?ocid=docs-wdatp-enablesiem-abovefoldlink)

エクスプロイト保護は、開発者がソフトウェアをコンパイルして配布した後に IT Proが適用できるアプリケーションに対して高度な保護を提供します。

この記事では、ポリシー レベルと個々の軽減レベルの両方で、Exploit Protection ポリシーを正常に構築して適用するのに役立つ、エクスプロイト保護のしくみを理解するのに役立ちます。

## <a name="how-mitigations-are-applied"></a>軽減策の適用方法

Exploit Protection の軽減策は、アプリケーションごとに適用されます。

軽減策は、保護を構成するプログラムごとにレジストリ エントリを使用して構成されます。 これらの設定は、各プログラムの **MitigationOptions** レジストリ エントリに格納されます (**HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Image File Execution Options \ *ImageFileName* \ MitigationOptions**)。 プログラムを再起動すると有効になり、変更してプログラムを再起動するまで有効なままになります。

> [!IMPORTANT]
> イメージ ファイル実行オプションでは、ファイル名またはパスのみを指定でき、バージョン番号、アーキテクチャ、その他の区別器は指定できません。 一意の名前またはパスを持つアプリに対する軽減策をターゲットにし、そのバージョンとそのアプリケーションのアーキテクチャをテストしたデバイスにのみ適用するように注意してください。

この XML 構成ファイルを処理するときに、PowerShell、グループ ポリシー、または MDM を使用して XML 構成ファイルを使用してエクスプロイト保護の軽減策を構成すると、個々のレジストリ設定が構成されます。

XML ファイルを配布するポリシーが適用されなくなった場合、この XML 構成ファイルによってデプロイされた設定は自動的に削除されません。 Exploit Protection の設定を削除するには、クリーン Windows 10またはWindows 11 デバイスから XML 構成をエクスポートし、この新しい XML ファイルをデプロイします。 または、Microsoft は、Exploit Protection 設定をリセットするためのWindows セキュリティベースラインの一部として XML ファイルを提供します。

PowerShell を使用してエクスプロイト保護設定をリセットするには、次のコマンドを使用します。

```powershell
Set-ProcessMitigation -PolicyFilePath EP-reset.xml
```
Windows セキュリティ基準と共に分散されるEP-reset.xmlを次に示します。
```xml
<?xml version="1.0" encoding="UTF-8"?>
<MitigationPolicy>
  <AppConfig Executable="ONEDRIVE.EXE">
    <DEP OverrideDEP="false" />
    <ASLR OverrideRelocateImages="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
    <ImageLoad OverrideBlockRemoteImages="false" />
  </AppConfig>
  <AppConfig Executable="firefox.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
  </AppConfig>
  <AppConfig Executable="fltldr.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
    <ImageLoad OverrideBlockRemoteImages="false" />
    <ChildProcess OverrideChildProcess="false" />
  </AppConfig>
  <AppConfig Executable="GROOVE.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
    <ImageLoad OverrideBlockRemoteImages="false" />
    <ChildProcess OverrideChildProcess="false" />
  </AppConfig>
  <AppConfig Executable="Acrobat.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="AcroRd32.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="chrome.exe">
    <DEP OverrideDEP="false" />
  </AppConfig>
  <AppConfig Executable="EXCEL.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="iexplore.exe">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="INFOPATH.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="java.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="javaw.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="javaws.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="LYNC.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="MSACCESS.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="MSPUB.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="OIS.EXE">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="OUTLOOK.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="plugin-container.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="POWERPNT.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="PPTVIEW.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="VISIO.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="VPREVIEW.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="WINWORD.EXE">
    <DEP OverrideDEP="false" />
    <ASLR ForceRelocateImages="true" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="wmplayer.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
  <AppConfig Executable="wordpad.exe">
    <DEP OverrideDEP="false" />
    <Payload OverrideEnableExportAddressFilter="false" OverrideEnableExportAddressFilterPlus="false" OverrideEnableImportAddressFilter="false" OverrideEnableRopStackPivot="false" OverrideEnableRopCallerCheck="false" OverrideEnableRopSimExec="false" />
  </AppConfig>
</MitigationPolicy>
```

## <a name="mitigation-reference"></a>軽減策リファレンス

以降のセクションでは、各エクスプロイト保護の軽減策によって提供される保護、軽減策の互換性に関する考慮事項、使用可能な構成オプションについて詳しく説明します。

## <a name="arbitrary-code-guard"></a>任意のコード ガード

### <a name="description"></a>説明

任意のコード ガードは、メモリの安全性の脆弱性を通じて任意のコードをメモリに読み込み、そのコードを実行できる悪意のある攻撃者から保護するのに役立ちます。

任意のコード ガードは、動的に生成されたコード (たとえば、exe 自体や dll から読み込まれないコード) を実行しないようにアプリケーションを保護します。 任意のコード ガードは、メモリが実行可能としてマークされないようにすることで機能します。 アプリケーションが [メモリを割り当て](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)ようとすると、保護フラグがチェックされます。 (メモリは、読み取り、書き込み、および/または実行保護フラグを使用して割り当てることができます。割り当てで [*実行*](/windows/win32/memory/memory-protection-constants) 保護フラグを含めようとした場合、メモリ割り当ては失敗し、エラー コード (STATUS_DYNAMIC_CODE_BLOCKED) を返します。 同様に、アプリケーションが既に割り当てられている [メモリの保護フラグを変更](/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect) しようとして [*、実行*](/windows/win32/memory/memory-protection-constants) 保護フラグが含まれている場合、アクセス許可の変更は失敗し、エラー コード (STATUS_DYNAMIC_CODE_BLOCKED) を返します。

*実行* フラグが設定されないようにすることで、Windows 10とWindows 11のデータ実行防止機能は、そのメモリに設定され、そのコードを実行している命令ポインターから保護できます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

任意のコード ガードにより、実行可能ファイルとしてのメモリの割り当てが禁止され、Just-In-Time (JIT) コンパイラなどのアプローチとの互換性の問題が発生します。 たとえば、ほとんどの最新のブラウザーでは、パフォーマンスを最適化するために JavaScript をネイティブ コードにコンパイルします。 この軽減策をサポートするには、JIT コンパイルを保護されたプロセスの外部に移動するために再設計する必要があります。 設計がスクリプトや他の中間言語からコードを動的に生成する他のアプリケーションも、同様にこの軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**スレッドのオプトアウトを許可** する - 個々のスレッドがこの保護をオプトアウトできるように軽減策を構成できます。 開発者は、この軽減策を認識してアプリケーションを記述し、このスレッドで動的コードを実行できるようにするために *、ThreadInformation* パラメーターを **ThreadDynamicCodePolicy** に設定して [**SetThreadInformation**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadinformation) API を呼び出している必要があります。

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 その後、監査イベントをイベント ビューアーで表示するか、 [Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview) で Advanced Hunting を使用して表示できます。

## <a name="block-low-integrity-images"></a>整合性が低いイメージのブロック

### <a name="description"></a>説明

整合性の低いイメージをブロックすると、通常はサンドボックス ブラウザーからインターネットからダウンロードされているため、信頼されていないファイルをアプリケーションが読み込めなくなります。

この軽減策は、イメージに低 IL プロセスへのアクセスを許可する Access Control エントリ (ACE) があり、信頼ラベル ACE がない場合、イメージの読み込みをブロックします。 これはメモリ マネージャーによって実装され、ファイルがメモリにマップされるのをブロックします。 アプリケーションが低整合性イメージをマップしようとすると、STATUS_ACCESS_DENIED エラーがトリガーされます。 整合性レベルのしくみの詳細については、「 [必須の整合性制御」を](/windows/win32/secauthz/mandatory-integrity-control)参照してください。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

整合性の低いイメージをブロックすると、アプリケーションがインターネットからダウンロードされたファイルを読み込めなくなります。 アプリケーション ワークフローでダウンロードされたイメージの読み込みが必要な場合は、高信頼プロセスからダウンロードされているか、この軽減策を適用するために明示的にラベルが変更されていることを確認する必要があります。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="block-remote-images"></a>リモート イメージのブロック

### <a name="description"></a>説明

リモート イメージをブロックすると、UNC 共有などのリモート デバイスでホストされているファイルがアプリケーションによって読み込まれるのを防ぐことができます。 リモート イメージをブロックすると、攻撃者が制御する外部デバイス上にあるメモリにバイナリを読み込むのを防ぐことができます。

この軽減策は、イメージがリモート デバイス上にあると判断された場合に、イメージの読み込みをブロックします。 これはメモリ マネージャーによって実装され、ファイルがメモリにマップされるのをブロックします。 アプリケーションがリモート ファイルをマップしようとすると、STATUS_ACCESS_DENIED エラーがトリガーされます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

リモート イメージをブロックすると、アプリケーションがリモート デバイスからイメージを読み込めなくなります。 アプリケーションがリモート デバイスからファイルまたはプラグインを読み込む場合は、この軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="block-untrusted-fonts"></a>信頼されていないフォントのブロック

### <a name="description"></a>説明

信頼されていないフォントをブロックすると、フォント解析の欠陥のリスクが軽減され、攻撃者はデバイスでコードを実行できるようになります。 WINDOWS\fonts ディレクトリにインストールされているフォントのみが、GDI によって処理されるように読み込まれます。

この軽減策は、ファイルの場所を検証する GDI 内で実装されます。 ファイルがシステム フォント ディレクトリにない場合、フォントは解析用に読み込まれず、その呼び出しは失敗します。

この軽減策は、Windows 10 1607 以降で提供される組み込みの軽減策と、フォント解析をカーネルからユーザー モード のアプリ コンテナーに移動するWindows 11に加えて行われます。 その結果、フォント解析に基づくあらゆる悪用は、サンドボックス化された分離されたコンテキストで発生し、リスクを大幅に軽減します。 この軽減策の詳細については、[ゼロデイ エクスプロイト軽減策を使用したセキュリティ強化Windows 10に関する](https://www.microsoft.com/security/blog/2017/01/13/hardening-windows-10-with-zero-day-exploit-mitigations/)ブログを参照してください。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

システム フォント ディレクトリの外部でフォントを使用する最も一般的な用途は、 [Web フォントです](/typography/fonts/font-faq#web)。 Microsoft Edgeなどの最新のブラウザーでは、GDI の代わりにDirectWriteが使用され、影響を受けられません。 ただし、Internet Explorer 11 (および新しいMicrosoft Edgeの IE モード) などの従来のブラウザーは、特にフォント グリフを使用して UI を表示するOffice 365などのアプリケーションでは影響を受ける可能性があります。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="code-integrity-guard"></a>コードの整合性ガード

### <a name="description"></a>説明

コード整合性ガードを使用すると、プロセスに読み込まれるすべてのバイナリが Microsoft によってデジタル署名されます。 コード整合性ガードには[、WHQL](/windows-hardware/drivers/install/whql-release-signature) (ハードウェア品質ラボWindows) 署名が含まれています。これにより、WHQL で承認されたドライバーをプロセス内で実行できます。

この軽減策はメモリ マネージャー内に実装されます。これにより、バイナリがメモリにマップされなくなります。 Microsoft によって署名されていないバイナリを読み込もうとすると、メモリ 管理人はエラー STATUS_INVALID_IMAGE_HASHを返します。 メモリ マネージャー レベルでブロックすることで、プロセスによって読み込まれるバイナリと、プロセスに挿入されたバイナリの両方を防止できます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、Microsoft によって署名されていないバイナリを特にブロックします。 そのため、そのソフトウェアがMicrosoft Storeによって配布 (およびデジタル署名) され、Microsoft Storeによって署名された画像の読み込みを許可するオプションが選択されている場合を除き、ほとんどのサードパーティソフトウェアと互換性がありません。

### <a name="configuration-options"></a>構成オプション

**また、Microsoft Storeによって署名されたイメージの読み込みを許可** します。Microsoft Storeによって配布されるアプリケーションはMicrosoft Storeによってデジタル署名され、この構成を追加すると、ストア認定プロセスを通過したバイナリをアプリケーションによって読み込むことができます。

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="control-flow-guard-cfg"></a>制御フロー ガード (CFG)

### <a name="description"></a>説明

制御フロー ガード (CFG) は、間接関数呼び出しを保護することで、攻撃者がメモリ破損の脆弱性を使用するリスクを軽減します。 たとえば、攻撃者はバッファー オーバーフローの脆弱性を使用して、関数ポインターを含むメモリを上書きし、その関数ポインターを任意の実行可能コードへのポインターに置き換える可能性があります (プログラムにも挿入されている可能性があります)。

この軽減策は、コンパイル時に別のチェックを挿入することで提供されます。 各間接関数呼び出しの前に、ターゲットが呼び出される前に有効な呼び出し先であることを確認する別の命令が追加されます。 ターゲットが有効な呼び出し先でない場合、アプリケーションは終了します。 そのため、この軽減策を利用できるのは、CFG サポートでコンパイルされたアプリケーションのみです。

有効なターゲットのチェックは、Windows カーネルによって提供されます。 実行可能ファイルが読み込まれると、間接呼び出しターゲットのメタデータが読み込み時に抽出され、有効な呼び出しターゲットとしてマークされます。 さらに、メモリが割り当てられ、実行可能としてマークされている場合 (生成されたコードなど) は、JIT コンパイルなどのメカニズムをサポートするために、これらのメモリの場所も有効な呼び出しターゲットとしてマークされます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

アプリケーションは CFG をサポートするためにコンパイルする必要があるため、アプリケーションとの互換性を暗黙的に宣言します。 そのため、ほとんどのアプリケーションは、この軽減策を有効にして動作する必要があります。 これらのチェックはバイナリにコンパイルされるため、適用できる構成は、単にWindows カーネル内のチェックを無効にすることです。 つまり、軽減策は既定でオンになっていますが、後でアプリケーション開発者がテストで検出しなかった互換性の問題があると判断した場合は、常に "はい" を返すようにWindows カーネルを構成できます。これはまれです。

### <a name="configuration-options"></a>構成オプション

**strict CFG を使用する** - 厳密モードでは、プロセスに読み込まれるすべてのバイナリを Control Flow Guard 用にコンパイルする必要があります (または、リソース dll などの実行可能コードが含まれていません)。

> [!Note]
> **制御フロー ガード** には監査モードがありません。 バイナリは、この軽減策を有効にしてコンパイルされます。

## <a name="data-execution-prevention-dep"></a>データ実行防止 (DEP)

### <a name="description"></a>説明

データ実行防止 (DEP) を使用すると、実行可能ファイルとして明示的に割り当てられていないメモリが実行されなくなります。 DEP は、バッファー オーバーフローを介して悪意のあるコードをプロセスに挿入し、そのコードを実行する攻撃者から保護するのに役立ちます。

命令ポインターを実行可能としてマークされていないメモリ アドレスに設定しようとすると、プロセッサによって例外 (一般的な保護違反) がスローされ、アプリケーションがクラッシュします。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

すべての x64、ARM、および ARM-64 実行可能ファイルは、既定で DEP が有効になっており、無効にすることはできません。 アプリケーションは DEP なしで実行されることはないため、互換性が想定されます。

すべての x86 (32 ビット) バイナリには既定で DEP が有効になっていますが、プロセスごとに DEP を無効にできます。 一部の古いレガシ アプリケーション (通常、Windows XP SP2 より前に開発されたアプリケーション) は、DEP と互換性がない場合があります。 このようなアプリケーションは、通常、コードを動的に生成する (JIT コンパイルなど) か、コードを動的に生成する古いライブラリ (古いバージョンの ATL など) にリンクします。

### <a name="configuration-options"></a>構成オプション

**ATL サンク エミュレーションを有効にする** - この構成オプションは、ATL サンク エミュレーションを無効にします。 ActiveX テンプレート ライブラリである ATL は、できるだけ小さく、高速になるように設計されています。 バイナリ サイズを小さくするために、 *サンキング* と呼ばれる手法を使用します。 サンキングは通常、32 ビットアプリケーションと 16 ビット アプリケーションの間で対話する場合と考えられますが、ここでは ATL に 16 ビット コンポーネントはありません。 代わりに、バイナリ サイズを最適化するために、ATL は単語アラインされていないマシン コードをメモリに格納し (より小さいバイナリを作成)、そのコードを直接呼び出します。 Visual Studio 7.1 以前 (Visual Studio 2003) でコンパイルされた ATL コンポーネントでは、このメモリは実行可能ファイルとして割り当てられません。サンク エミュレーションでは互換性の問題が解決されます。 バイナリ拡張モデル (Internet Explorer 11 など) を持つアプリケーションでは、多くの場合、ATL サンク エミュレーションを有効にする必要があります。

## <a name="disable-extension-points"></a>拡張ポイントの無効化

### <a name="description"></a>説明

この軽減策は、アプリケーションのさまざまな拡張ポイントを無効にします。これは、永続性を確立したり、悪意のあるコンテンツの特権を昇格したりするために使用される可能性があります。

保持されるデータには以下が含まれます。

- **AppInit DLL** - プロセスが開始されるたびに、システムはエントリ ポイント関数を呼び出す前に、指定された DLL を新しく開始されたプロセスのコンテキストに読み込みます。 [AppInit DLL の詳細については、こちらを参照してください](/windows/win32/winmsg/about-window-classes#application-global-classes)。 この軽減策を適用すると、AppInit DLL は読み込まれません。 Windows 7 以降では、[ここで説明するように](/windows/win32/win7appqual/appinit-dlls-in-windows-7-and-windows-server-2008-r2)、AppInit DLL にデジタル署名する必要があります。 さらに、Windows 8 以降では、SecureBoot が有効になっている場合、AppInit DLL は読み込まれません。[ここで説明します](/windows/win32/dlls/secure-boot-and-appinit-dlls)。
- **レガシ IIME** - 入力メソッド エディター (IME) を使用すると、キーボードで表すことができる文字数を超える言語でテキストを入力できます。 サード パーティは IME を作成できます。 悪意のある IME は、この入力キャプチャから資格情報またはその他の機密情報を取得する可能性があります。 レガシ IME と呼ばれる一部の IME は、UWP アプリではなく、デスクトップ アプリWindowsでのみ機能します。 この軽減策により、このレガシ IME が指定されたWindowsデスクトップ アプリに読み込めなくなります。
- **Windows イベント フック** - アプリケーションは [SetWinEventHook API](/windows/win32/api/winuser/nf-winuser-setwineventhook) を呼び出して、イベントの発生に関心を登録できます。 DLL が指定され、プロセスに挿入できます。 この軽減策により、挿入された DLL を介してインプロセスを実行するのではなく、フックを登録プロセスに強制的にポストします。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

これらの拡張ポイントのほとんどは比較的頻繁に使用されないため、互換性への影響は通常、特に個々のアプリケーション レベルで小さくなります。 1 つの考慮事項は、ユーザーが保護されたアプリケーションで動作しないサード パーティのレガシ IME を使用している場合です。

### <a name="configuration-options"></a>構成オプション

この軽減策の構成オプションはありません。

> [!Note]
> **拡張機能ポイントを無効にすると** 、監査モードはありません。

## <a name="disable-win32k-system-calls"></a>Win32k システム コールの無効化

### <a name="description"></a>説明

Win32k.sysは、攻撃者に広範な攻撃領域を提供します。 カーネル モード コンポーネントとして、サンドボックス化されたアプリケーションのエスケープ ベクターとして頻繁にターゲットにされます。 この軽減策により、スレッドが自身を GUI スレッドに変換するのをブロックすることで、win32k.sysへの呼び出しが防止され、Win32k 関数を呼び出すアクセス権が与えられます。 スレッドは作成時に GUI 以外ですが、最初の呼び出しで win32k.sys に変換されるか、 [IsGuiThread](/windows/win32/api/winuser/nf-winuser-isguithread) への API 呼び出しを使用して変換されます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、専用の非 UI プロセスであるプロセス向けに設計されています。 たとえば、多くの最新のブラウザーではプロセス分離が使用され、UI 以外のプロセスが組み込まれます。 1 つのプロセスを使用して GUI を表示するすべてのアプリケーションは、この軽減策の影響を受けます。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="do-not-allow-child-processes"></a>子プロセスを許可しない

### <a name="description"></a>説明

この軽減策により、アプリケーションが新しい子アプリケーションを作成できなくなります。 敵対者が使用する一般的な手法は、悪意のある入力 ("陸から離れた生活" 攻撃) を使用してデバイスで信頼されたプロセスを開始することです。多くの場合、デバイスで別のアプリケーションを起動する必要があります。 アプリケーションが子プロセスを起動する正当な理由がない場合、この軽減策により、潜在的な攻撃ベクトルが軽減されます。 軽減策は、プロセス トークンにプロパティを設定することで適用されます。これにより、エラー メッセージがSTATUS_CHILD_PROCESS_BLOCKEDされた子プロセスのトークンの作成がブロックされます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

ブラウザーまたは外部ブラウザーを起動するハイパーリンクや、コンピューター上の他のユーティリティを起動するハイパーリンクのサポートなど、何らかの理由でアプリケーションが子アプリケーションを起動した場合、この機能は、この軽減策が適用されて中断されます。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="export-address-filtering"></a>アドレスフィルターをエクスポートする

### <a name="description"></a>説明

エクスポート アドレス フィルター (EAF) は、読み込まれたすべてのモジュールのエクスポート アドレス テーブルを見て、攻撃に役立つ API を含むモジュールを見つける悪意のあるコードのリスクを軽減します。 これはシェルコードで使用される一般的な方法です。 このような攻撃のリスクを軽減するために、この軽減策は、一般的に攻撃される 3 つのモジュールを保護します。

- ntdll.dll
- kernelbase.dll
- kernel32.dll

軽減策は、[エクスポート [アドレス テーブル](/windows/win32/debug/pe-format#export-address-table)を指すエクスポート ディレクトリ] のメモリ ページを保護します。 このメモリ ページには [、PAGE_GUARD](/windows/win32/memory/creating-guard-pages) 保護が適用されます。 誰かがこのメモリにアクセスしようとすると、STATUS_GUARD_PAGE_VIOLATIONが生成されます。 軽減策によってこの例外が処理され、アクセス命令が検証に合格しない場合、プロセスは終了します。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、主に、デバッガー、サンドボックス アプリケーション、DRM を使用するアプリケーション、デバッグ対策テクノロジを実装するアプリケーションなどのアプリケーションの問題です。

### <a name="configuration-options"></a>構成オプション

**悪用によって一般的に悪用されるモジュールのアクセスを検証する** - このオプション (EAF+ とも呼ばれます) は、一般的に攻撃される他のモジュールの保護を追加します。

- `mshtml.dll`
- `flash*.ocx`
- `jscript*.ocx`
- `vbscript.dll`
- `vgx.dll`
- `mozjs.dll`
- `xul.dll`
- `acrord32.dll`
- `acrofx32.dll`
- `acroform.api`

さらに、EAF+ を有効にすることで、この軽減策により、PE ファイル内の [DOS](/windows/win32/debug/pe-format#ms-dos-stub-image-only) ヘッダーの最初の 2 バイトである "MZ" ヘッダーを含むページにPAGE_GUARD保護が追加されます。これは、シェルコードがメモリに関心がある可能性のあるモジュールを識別するために検索できる既知のメモリ コンテンツのもう 1 つの側面です。

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="force-randomization-for-images-mandatory-aslr"></a>イメージのランダム化の強制 (必須 ASLR)

### <a name="description"></a>説明

アドレス空間レイアウトランダム化 (ASLR) は、プロセス メモリに既に存在し、実行可能として既にマークされているコードを実行するために、システムのメモリ レイアウトに関する知識を使用して攻撃者のリスクを軽減します。 これにより、敵対者がコンテキストを設定し、敵対者の目的に合ったコンテキストで既存のコードを実行するようにリターン アドレスを変更する、return-to-libc 攻撃などの手法を使用して攻撃者のリスクを軽減できます。

必須の ASLR は、プロセス内のすべての DLL のリベースを強制します。 開発者は [、/DYNAMICBASE](/cpp/build/reference/dynamicbase-use-address-space-layout-randomization) リンカー オプションを使用して ASLR を有効にできます。この軽減策も同じ効果があります。

メモリ マネージャーがイメージ内でプロセスにマッピングされている場合、必須 ASLR は、ASLR にオプトインしていない DLL と EXE を強制的にリベースします。 ただし、この再調整にはエントロピがないため、メモリ内の予測可能な場所に配置できることに注意してください。 バイナリのリベースおよびランダム化された場所の場合、この軽減策は [ランダム化メモリ割り当て (Bottom-up ASLR)](#randomize-memory-allocations-bottom-up-aslr) とペアにする必要があります。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

ASLR のこの互換性への影響は、通常、バイナリ ファイルのベース アドレスに関する前提を作成したり、基本再配置情報を削除したりするコンパイラを使用して構築された古いアプリケーションに制約されます。 これにより、実行フローがメモリ内の実際の場所ではなく、予期した場所にジャンプしようとすると、予期しないエラーが発生する可能性があります。

### <a name="configuration-options"></a>構成オプション

**削除されたイメージを許可しない** - このオプションは、再配置情報が削除されたイメージの読み込みをブロックします。 Windows PE ファイル形式には絶対アドレスが含まれており、コンパイラは、ローダーがすべての相対メモリ参照とそのオフセットを検索するために使用できる [基本再配置テーブル] も生成するため、バイナリが優先ベース アドレスで読み込まれない場合に更新できます。 一部の古いアプリケーションでは、運用環境のビルドでこの情報を取り除くので、これらのバイナリをリベースすることはできません。 この軽減策により、このようなバイナリの読み込みがブロックされます (優先ベース アドレスで読み込むことが許可されるのではなく)。

> [!Note]
> **イメージの強制的なランダム化 (必須 ASLR)** には監査モードがありません。

## <a name="import-address-filtering-iaf"></a>インポート アドレス フィルター (IAF)

### <a name="description"></a>説明

インポート アドレス フィルター (IAF) 軽減策は、インポート アドレス テーブル (IAT) を変更して、その関数が呼び出されたときに攻撃者が選択した任意のコードにリダイレクトすることで、敵対者がアプリケーションの制御フローを変更するリスクを軽減するのに役立ちます。 攻撃者は、この方法を使用して制御を乗っ取ったり、機密性の高い API の呼び出しを傍受、検査、ブロックしたりする可能性があります。

保護されているすべての API のメモリ ページには、 [PAGE_GUARD](/windows/win32/memory/creating-guard-pages) 保護が適用されます。 誰かがこのメモリにアクセスしようとすると、STATUS_GUARD_PAGE_VIOLATIONが生成されます。 軽減策によってこの例外が処理され、アクセス命令が検証に合格しない場合、プロセスは終了します。

この軽減策は、次のWindows API を保護します。

- `GetProcAddress`
- `GetProcAddressForCaller`
- `LoadLibraryA`
- `LoadLibraryExA`
- `LoadLibraryW`
- `LoadLibraryExW`
- `LdrGetProcedureAddress`
- `LdrGetProcedureAddressEx`
- `LdrGetProcedureAddressForCaller`
- `LdrLoadDll`
- `VirtualProtect`
- `VirtualProtectEx`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `NtProtectVirtualMemory`
- `CreateProcessA`
- `CreateProcessW`
- `WinExec`
- `CreateProcessAsUserA`
- `CreateProcessAsUserW`
- `GetModuleHandleA`
- `GetModuleHandleW`
- `RtlDecodePointer`
- `DecodePointer`

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

API インターセプトを実行する正当なアプリケーションは、この軽減策によって検出され、一部のアプリケーションがクラッシュする可能性があります。 たとえば、セキュリティ ソフトウェアとアプリケーションの互換性 shim が含まれます。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="randomize-memory-allocations-bottom-up-aslr"></a>メモリ割り当てをランダム化する (Bottom-up ASLR)

### <a name="description"></a>説明

ランダム化メモリ割り当て (Bottom-up ASLR) は、再配置にエントロピを追加するため、その場所はランダム化されるため、予測不可能です。 この軽減策では、必須の ASLR を有効にする必要があります。

32 ビット アドレス空間のサイズは、追加できるエントロピに実用的な制約があるため、64 ビット アプリケーションでは、攻撃者がメモリ内の場所を推測することがより困難になります。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

必須 ASLR (リベース) と互換性のあるほとんどのアプリケーションは、Bottom-up ASLR の他のエントロピとも互換性があります。 一部のアプリケーションでは、ローカル ポインターを 32 ビット変数に保存する場合 (ベース アドレスが 4 GB 未満を想定)、ポインター切り捨ての問題が発生する可能性があるため、高エントロピ オプション (無効にできる) と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**高エントロピを使用しないでください** 。このオプションでは、64 ビット アプリケーションのボトムアップ割り当てに 24 ビットのエントロピ (1 TB の分散) を追加する高エントロピ ASLR の使用が無効になります。

> [!Note]
> **ランダム化メモリ割り当て (Bottom-up ASLR)** には監査モードがありません。

## <a name="simulate-execution-simexec"></a>実行のシミュレート (SimExec)

### <a name="description"></a>説明

シミュレーション実行 (SimExec) は、32 ビット アプリケーションのみの軽減策です。 これにより、機密性の高い API の呼び出しが正当な呼び出し元関数に返されることを検証できます。 これは、呼び出しを機密性の高い API にインターセプトし、呼び出し元に戻る必要がある RET 命令を探してエンコードされたアセンブリ言語命令を調べて、それらの API の実行をシミュレートすることによって行われます。 次に、その関数を検査し、メモリ内を後方に移動して、前の CALL 命令を見つけて、関数と CALL 命令が一致するかどうか、および RET がインターセプトされていないかどうかを判断します。

この軽減策によってインターセプトされる API は次のとおりです。

- `LoadLibraryA`
- `LoadLibraryW`
- `LoadLibraryExA`
- `LoadLibraryExW`
- `LdrLoadDll`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `VirtualProtect`
- `VirtualProtectEx`
- `NtProtectVirtualMemory`
- `HeapCreate`
- `RtlCreateHeap`
- `CreateProcessA`
- `CreateProcessW`
- `CreateProcessInternalA`
- `CreateProcessInternalW`
- `NtCreateUserProcess`
- `NtCreateProcess`
- `NtCreateProcessEx`
- `CreateRemoteThread`
- `CreateRemoteThreadEx`
- `NtCreateThreadEx`
- `WriteProcessMemory`
- `NtWriteVirtualMemory`
- `WinExec`
- `CreateFileMappingA`
- `CreateFileMappingW`
- `CreateFileMappingNumaW`
- `NtCreateSection`
- `MapViewOfFile`
- `MapViewOfFileEx`
- `MapViewOfFileFromApp`
- `LdrGetProcedureAddressForCaller`

ROP ガジェットが検出されると、プロセスは終了します。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

API インターセプト (特にセキュリティ ソフトウェア) を実行するアプリケーションは、この軽減策との互換性の問題を引き起こす可能性があります。

この軽減策は、任意の Code Guard 軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="validate-api-invocation-callercheck"></a>API 呼び出しの検証 (CallerCheck)

### <a name="description"></a>説明

Validate API 呼び出し (CallerCheck) は、有効な呼び出し元から機密 API が呼び出されたことを検証するリターン指向プログラミング (ROP) 手法の軽減策です。 この軽減策は、渡された戻りアドレスを調べ、ヒューリスティックに逆アセンブルして戻りアドレスの上の呼び出しを見つけて、呼び出し先が関数に渡されたパラメーターと一致するかどうかを判断します。

この軽減策によってインターセプトされる API は次のとおりです。

- `LoadLibraryA`
- `LoadLibraryW`
- `LoadLibraryExA`
- `LoadLibraryExW`
- `LdrLoadDll`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `VirtualProtect`
- `VirtualProtectEx`
- `NtProtectVirtualMemory`
- `HeapCreate`
- `RtlCreateHeap`
- `CreateProcessA`
- `CreateProcessW`
- `CreateProcessInternalA`
- `CreateProcessInternalW`
- `NtCreateUserProcess`
- `NtCreateProcess`
- `NtCreateProcessEx`
- `CreateRemoteThread`
- `CreateRemoteThreadEx`
- `NtCreateThreadEx`
- `WriteProcessMemory`
- `NtWriteVirtualMemory`
- `WinExec`
- `CreateFileMappingA`
- `CreateFileMappingW`
- `CreateFileMappingNumaW`
- `NtCreateSection`
- `MapViewOfFile`
- `MapViewOfFileEx`
- `MapViewOfFileFromApp`
- `LdrGetProcedureAddressForCaller`

ROP ガジェットが検出されると、プロセスは終了します。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

API インターセプト (特にセキュリティ ソフトウェア) を実行するアプリケーションは、この軽減策との互換性の問題を引き起こす可能性があります。

この軽減策は、任意の Code Guard 軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="validate-exception-chains-sehop"></a>例外チェーンの検証 (SEHOP)

### <a name="description"></a>説明

例外チェーンの検証 (SEHOP) は、 *構造化例外ハンドラー (SEH) の上書き* 悪用手法に対する軽減策です。 [構造化例外処理](/windows/win32/debug/structured-exception-handling) は、アプリケーションが特定の例外の処理を要求できるプロセスです。 例外ハンドラーは連結されるため、1 つの例外ハンドラーが特定の例外を処理しないことを選択した場合は、処理を決定するまでチェーン内の次の例外ハンドラーに渡すことができます。 ハンドラーの一覧は動的であるため、スタックに格納されます。 攻撃者はスタック オーバーフローの脆弱性を使用して、攻撃者が選択したコードへのポインターで例外ハンドラーを上書きできます。

この軽減策は、SEH の設計に依存します。各 SEH エントリには、例外ハンドラーへのポインターと、例外チェーン内の次のハンドラーへのポインターの両方が含まれます。 この軽減策は例外ディスパッチャーによって呼び出され、例外が呼び出されたときに SEH チェーンが検証されます。 次のことが確認されます。

- すべての例外チェーン レコードがスタック境界内にある
- すべての例外レコードがアラインされます
- 例外ハンドラー ポインターがスタックを指していない
- 逆方向のポインターはありません
- 例外チェーンは、既知の最終的な例外ハンドラーで終了します

これらの検証が失敗した場合、例外処理は中止され、例外は処理されません。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

SEHOP との互換性の問題は比較的まれです。 アプリケーションが例外チェーンの破損に依存することはまれです。 ただし、一部のアプリケーションはタイミングの微妙な変化の影響を受けます。これは、アプリケーション内の潜在的なマルチスレッドバグを明らかにする競合状態として明らかにされる可能性があります。

### <a name="configuration-options"></a>構成オプション

> [!Note]
> **例外チェーン (SEHOP)** に監査モードがないことを検証します。

## <a name="validate-handle-usage"></a>ハンドルの使用状態の検証

### <a name="description"></a>説明

*ハンドルの使用状況を検証* することは、既存のハンドルを使用して保護されたオブジェクトにアクセスする攻撃者から保護するのに役立つ軽減策です。 [ハンドル](/windows/win32/sysinfo/handles-and-objects)は、保護されたオブジェクトへの参照です。 アプリケーション コードが無効なハンドルを参照している場合は、敵対者が以前に記録したハンドルを使用しようとしていることを示している可能性があります (ただし、どのアプリケーション参照カウントが認識されないか)。 アプリケーションが単に null を返すのではなく、無効なオブジェクトを使用しようとすると、アプリケーションは例外 (STATUS_INVALID_HANDLE) を発生させます。

この軽減策は、Windows ストア アプリケーションに自動的に適用されます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

ハンドル参照を正確に追跡せず、例外ハンドラーでこれらの操作をラップしていないアプリケーションは、この軽減策の影響を受ける可能性があります。

### <a name="configuration-options"></a>構成オプション

> [!Note]
> **ハンドルの使用状況** に監査モードがないことを検証します。

## <a name="validate-heap-integrity"></a>ヒープの整合性の検証

### <a name="description"></a>説明

*ヒープ整合性の検証* の軽減策は、ヒープの破損が検出された場合にアプリケーションを終了させることで、Windowsのヒープ軽減策の保護レベルを向上させます。 軽減策は次のとおりです。

- HEAP ハンドルが解放されないようにする
- ヒープ割り当ての拡張ブロック ヘッダーに対して別の検証を実行する
- ヒープ割り当てがまだ使用中としてフラグが設定されていないことを確認する
- 最小サイズを超える大規模な割り当て、ヒープ セグメント、およびサブセグメントへのガード ページの追加

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

この軽減策は、64 ビット アプリケーションと、Vista 以降を対象とする 32 ビット アプリケーションWindows既定で既に適用されています。 Windows XP 以前のレガシ アプリケーションが最も危険にさらされていますが、互換性の問題はまれです。

### <a name="configuration-options"></a>構成オプション

> [!Note]
> **ヒープの整合性** に監査モードがないことを検証します。

## <a name="validate-image-dependency-integrity"></a>軽減策の依存関係の整合性の検証

### <a name="description"></a>説明

*検証イメージの依存関係* の軽減策は、Windows バイナリによって静的にリンクされている dll のコードを置き換えようとする攻撃から保護するのに役立ちます。 DLL を植え付ける手法は、ローダーの検索メカニズムを悪用して悪意のあるコードを挿入します。これは、管理者特権で実行されている悪意のあるコードを取得するために使用できます。 ローダーが署名されたバイナリWindows読み込んでから、バイナリが依存するすべての dll を読み込むと、これらのバイナリもWindowsバイナリとしてデジタル署名されていることを確認します。 署名チェックに失敗した場合、dll は読み込まれず、例外がスローされ、STATUS_INVALID_IMAGE_HASHの状態が返されます。

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

互換性の問題は一般的ではありません。 Windows バイナリをローカル プライベート バージョンに置き換えることに依存するアプリケーションは影響を受け、マルチスレッド アプリケーションでわずかなタイミングバグが明らかになるリスクも小さくなります。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。

## <a name="validate-stack-integrity-stackpivot"></a>スタックの整合性の検証 (StackPivot)

### <a name="description"></a>説明

*スタック整合性の検証 (StackPivot)* 軽減策は、スタック ピボット攻撃 (攻撃者がヒープ メモリに偽のスタックを作成する ROP 攻撃) から保護し、実行のフローを制御する偽のスタックにアプリケーションを誘導するのに役立ちます。

この軽減策は、多数のWindows API をインターセプトし、スタック ポインターの値を検査します。 スタック ポインターのアドレスがスタックの下部と上部の間にない場合は、イベントが記録され、監査モードでない場合はプロセスが終了します。

この軽減策によってインターセプトされる API は次のとおりです。

- `LoadLibraryA`
- `LoadLibraryW`
- `LoadLibraryExA`
- `LoadLibraryExW`
- `LdrLoadDll`
- `VirtualAlloc`
- `VirtualAllocEx`
- `NtAllocateVirtualMemory`
- `VirtualProtect`
- `VirtualProtectEx`
- `NtProtectVirtualMemory`
- `HeapCreate`
- `RtlCreateHeap`
- `CreateProcessA`
- `CreateProcessW`
- `CreateProcessInternalA`
- `CreateProcessInternalW`
- `NtCreateUserProcess`
- `NtCreateProcess`
- `NtCreateProcessEx`
- `CreateRemoteThread`
- `CreateRemoteThreadEx`
- `NtCreateThreadEx`
- `WriteProcessMemory`
- `NtWriteVirtualMemory`
- `WinExec`
- `CreateFileMappingA`
- `CreateFileMappingW`
- `CreateFileMappingNumaW`
- `NtCreateSection`
- `MapViewOfFile`
- `MapViewOfFileEx`
- `MapViewOfFileFromApp`
- `LdrGetProcedureAddressForCaller`

### <a name="compatibility-considerations"></a>互換性に関する考慮事項

偽のスタックを使用しているアプリケーションは影響を受け、マルチスレッド アプリケーションで微妙なタイミングバグが明らかにされるリスクも小さくなります。
API インターセプト (特にセキュリティ ソフトウェア) を実行するアプリケーションは、この軽減策との互換性の問題を引き起こす可能性があります。

この軽減策は、任意の Code Guard 軽減策と互換性がありません。

### <a name="configuration-options"></a>構成オプション

**監査のみ** - アプリケーションに対する潜在的な互換性への影響を測定するために、監査モードでこの軽減策を有効にすることができます。 監査イベントは、イベント ビューアーで表示することも、[Microsoft Defender for Endpoint](/microsoft-365/security/defender/advanced-hunting-overview)の高度なハンティングを使用して表示することもできます。
